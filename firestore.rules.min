rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    function isAuthenticated() {
      return request.auth != null;
    }
    function getUserClaims() {
      return request.auth.token;
    }
    function getOrganizationId() {
      return getUserClaims().get('organizationId', '');
    }
    function belongsToOrganization(organizationId) {
      return getOrganizationId() == organizationId || 
             organizationId in getUserClaims().get('allowedOrganizations', []);
    }
    function belongsToOrganizationWithDocCheck(organizationId) {
      return belongsToOrganization(organizationId);
    }
    function hasRole(role) {
      return isAuthenticated() && getUserClaims().get('role', '') == role;
    }
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserClaims().get('role', '') in roles;
    }
    function hasOrgRole(role) {
      return isAuthenticated() && (getUserClaims().get('role', '') == role || getUserClaims().get('teamMemberRole', '') == role);
    }
    function hasAnyOrgRole(roles) {
      return isAuthenticated() && (getUserClaims().get('role', '') in roles || getUserClaims().get('teamMemberRole', '') in roles);
    }
    function isOwnerOrAdmin() {
      return isAuthenticated() && (
        getUserClaims().get('isOwnerOrAdmin', false) ||
        hasAnyRole(['OWNER', 'ADMIN', 'SUPERADMIN', 'SUPER_ADMIN'])
      );
    }
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    function canAccessProject(projectId) {
      return isAuthenticated() && (
        projectId in getUserClaims().get('projectAssignments', {}) ||
        belongsToOrganization(get(/databases/$(database)/documents/projects/$(projectId)).data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    function canModifyProject(projectId) {
      return isAuthenticated() && (
        (projectId in getUserClaims().get('projectAssignments', {}) &&
         getUserClaims().get('projectAssignments', {})[projectId].get('baseRole', '') in ['ADMIN', 'DO_ER']) ||
        (belongsToOrganization(get(/databases/$(database)/documents/projects/$(projectId)).data.organizationId) && isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    function hasMinimumHierarchy(minLevel) {
      return isAuthenticated() && (
        getUserClaims().get('effectiveHierarchy', 0) >= minLevel ||
        getUserClaims().get('hierarchy', 0) >= minLevel
      );
    }
    function hasEDLConverterAccess() {
      return isAuthenticated() && getUserClaims().get('isEDLConverter', false);
    }
    function hasCallSheetAccess() {
      return isAuthenticated() && getUserClaims().get('isCallSheetUser', false);
    }
    function getWalletAddresses() {
      let addresses = getUserClaims().get('walletAddresses', []);
      return addresses.size() > 0 ? addresses : 
             (getUserClaims().get('walletAddress', '') != '' ? [getUserClaims().get('walletAddress', '')] : []);
    }
    function hasWalletAddress(address) {
      return isAuthenticated() && address != '' && (
        getWalletAddresses().hasAny([address.lower()]) || 
        getWalletAddresses().hasAny([address])
      );
    }
    function canVerifyBlockchain() {
      return isAuthenticated() && (
        getWalletAddresses().size() > 0 ||
        isOwnerOrAdmin()
      );
    }
    function verifiedByUserWallet(documentData) {
      return isAuthenticated() && 
             documentData.get('blockchainMetadata', {}).get('verifiedBy', '') != '' &&
             getWalletAddresses().hasAny([documentData.get('blockchainMetadata', {}).get('verifiedBy', '').lower()]);
    }
    function isStandaloneUser() {
      return isAuthenticated() && getUserClaims().get('isStandaloneUser', false);
    }
    function hasPageReadAccess(pageId) {
      return isAuthenticated() && (
        isOwnerOrAdmin() ||
        getUserClaims().get('pagePermissions', {}).get('page:' + pageId + ':read', false) ||
        getUserClaims().get('page:' + pageId + ':read', false)
      );
    }
    function hasPageWriteAccess(pageId) {
      return isAuthenticated() && (
        isOwnerOrAdmin() ||
        getUserClaims().get('page:' + pageId + ':write', false) ||
        (getUserClaims().get('pagePermissions', {}) != null && 
         getUserClaims().get('pagePermissions', {}).get(pageId, {}) != null &&
         getUserClaims().get('pagePermissions', {}).get(pageId, {}).get('write', false))
      );
    }
    function hasClipShowProAccess() {
      return isAuthenticated() && (
        getUserClaims().get('hasClipShowProAccess', false) ||
        isOwnerOrAdmin()
      );
    }
    function hasCueSheetAccess() {
      return isAuthenticated() && (
        getUserClaims().get('hasCueSheetAccess', false) ||
        isOwnerOrAdmin()
      );
    }
    function hasParserBrainAccess() {
      return isAuthenticated() && (
        getUserClaims().get('parserBrainAccess', false) ||
        isOwnerOrAdmin() ||
        'PARSER_BRAIN' in getUserClaims().get('permissions', [])
      );
    }
    function hasIndexedFilesAccess() {
      return hasClipShowProAccess() || hasCueSheetAccess();
    }
    function isLicensingSpecialist() {
      return isAuthenticated() && (
        getUserClaims().get('role', '') == 'LICENSING_SPECIALIST' ||
        getUserClaims().get('isLicensingSpecialist', false) ||
        'licensing_specialist' in getUserClaims().get('permissions', [])
      );
    }
    function canAccessLicensingData(organizationId) {
      return isAuthenticated() && (
        (isLicensingSpecialist() && belongsToOrganization(organizationId)) ||
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(organizationId))
      );
    }
    function canModifyLicensingData(organizationId) {
      return isAuthenticated() && (
        (isLicensingSpecialist() && belongsToOrganization(organizationId)) ||
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(organizationId) && 
         hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])) ||
        (belongsToOrganization(organizationId) && (
          hasPageWriteAccess('clearance') ||
          hasPageWriteAccess('pitching')
        ))
      );
    }
    match /roleSyncEvents/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    match /dataSyncEvents/{eventId} {
      allow read: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (resource.data != null && resource.data.userId == request.auth.uid)
      );
      allow create: if isAuthenticated() && 
        request.resource.data.userId != null &&
        (request.resource.data.userId == request.auth.uid || isOwnerOrAdmin());
      allow update, delete: if isAuthenticated() && 
        resource.data != null &&
        (resource.data.userId == request.auth.uid || isOwnerOrAdmin());
    }
    match /projectAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId ||
        canAccessProject(resource.data.projectId)
      );
      allow write: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || isOwnerOrAdmin());
    }
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId) ||
        isAuthenticated()
      );
      allow write: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow create: if isAuthenticated() && isOwnerOrAdmin();
      allow update: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      match /callsheet-projects/{projectId} {
        allow read: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          resource.data.ownerId == request.auth.uid ||
          request.auth.uid == resource.data.userId
        );
        allow create: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          request.resource.data.ownerId == request.auth.uid ||
          request.resource.data.userId == request.auth.uid
        );
        allow update: if isAuthenticated() && (
          (belongsToOrganization(orgId) && isOwnerOrAdmin()) ||
          resource.data.ownerId == request.auth.uid ||
          request.auth.uid == resource.data.userId
        );
        allow delete: if isAuthenticated() && (
          (belongsToOrganization(orgId) && isOwnerOrAdmin()) ||
          resource.data.ownerId == request.auth.uid ||
          request.auth.uid == resource.data.userId
        );
      }
      match /nleSourceFolders/{folderId} {
        allow read: if isAuthenticated() && (
          (resource.data == null && (belongsToOrganization(orgId) || hasClipShowProAccess())) ||
          (resource.data != null && (belongsToOrganization(orgId) || hasClipShowProAccess()))
        );
        allow create: if isAuthenticated() && (
          belongsToOrganization(orgId) && isOwnerOrAdmin()
        );
        allow update: if isAuthenticated() && (
          belongsToOrganization(orgId) && isOwnerOrAdmin()
        );
        allow delete: if isAuthenticated() && (
          belongsToOrganization(orgId) && isOwnerOrAdmin()
        );
        match /files/{fileId} {
          allow read, write, create: if isAuthenticated() && 
            belongsToOrganization(orgId);
        }
      }
    }
    match /teamMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (request.auth.uid == resource.data.userId && 
         belongsToOrganization(resource.data.organizationId)) ||
        (isOwnerOrAdmin() && (
          belongsToOrganization(resource.data.organizationId) ||
          (exists(/databases/$(database)/documents/teamMembers/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/teamMembers/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
           getUserClaims().get('role', '') in ['OWNER', 'ADMIN', 'SUPERADMIN', 'SUPER_ADMIN']
        ))
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /projectTeamMembers/{assignmentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /project_team_members/{assignmentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /project_participants/{participantId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /project_datasets/{linkId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
      allow write: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin();
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /datasets/{datasetId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
      allow write: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && 
                     resource.data != null &&
                     canModifyProject(projectId);
      allow delete: if isAuthenticated() && 
                     resource.data != null &&
                     belongsToOrganization(resource.data.organizationId) && 
                     isOwnerOrAdmin();
    }
    match /folders/{folderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && (
        isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /projectFolderAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        (resource.data == null && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
    }
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    match /networkDeliveryBibles/{bibleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /timecards/{timecardId} {
      allow read: if isOwner(resource.data.userId) || 
                     canAccessProject(resource.data.projectId);
      allow create: if canAccessProject(request.resource.data.projectId);
      allow update: if isOwner(resource.data.userId) || 
                       canModifyProject(resource.data.projectId);
    }
    match /timecardTemplates/{templateId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    match /timecardAssignments/{assignmentId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    match /timecardConfigurations/{configId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    match /inventoryItems/{itemId} {
      allow read: if canAccessProject(resource.data.projectId);
      allow write: if canModifyProject(resource.data.projectId);
    }
    match /reports/{reportId} {
      allow read: if canAccessProject(resource.data.projectId);
      allow create: if canAccessProject(request.resource.data.projectId);
      allow update: if isOwner(resource.data.userId) || 
                       canModifyProject(resource.data.projectId);
    }
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId) || isOwnerOrAdmin();
      allow create: if true; 
      allow update: if isOwner(resource.data.userId) || isOwnerOrAdmin();
      allow delete: if isOwner(resource.data.userId) || isOwnerOrAdmin();
    }
    match /notificationPreferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
    }
    match /userTableViews/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    match /licenses/{licenseId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        (isAuthenticated() && resource.data.userId == request.auth.uid) ||
        isAuthenticated()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        (isAuthenticated() && request.resource.data.userId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        isAuthenticated()
      );
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) && 
         hasAnyOrgRole(['owner', 'admin'])) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && 
         hasAnyOrgRole(['owner', 'admin'])) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    match /standaloneLicenses/{licenseId} {
      allow read: if isAuthenticated() && (
        isAuthenticated() ||
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
      allow create: if isAuthenticated() && (
        isAuthenticated() && 
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
    }
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid ||
        isOwnerOrAdmin() ||
        (isAuthenticated() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin()) ||
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.firebaseUid == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        isOwnerOrAdmin()
      );
    }
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid ||
        isOwnerOrAdmin() ||
        (isAuthenticated() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin()) ||
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.firebaseUid == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        isOwnerOrAdmin()
      );
    }
    match /orgMembers/{memberId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganization(resource.data.orgId) ||
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.firebaseUid ||
        isOwnerOrAdmin() ||
        (isAuthenticated() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganization(request.resource.data.orgId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        ((belongsToOrganization(resource.data.organizationId) ||
          belongsToOrganization(resource.data.orgId)) && isOwnerOrAdmin()) ||
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.firebaseUid
      );
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganization(resource.data.orgId)) && 
        isOwnerOrAdmin()
      );
    }
    match /callsheetCallSheets/{callSheetId} {
      allow read, write: if isAuthenticated();
    }
    match /callsheets/{callSheetId} {
      allow read, write: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
    }
    match /callSheets/{callSheetId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid
      );
    }
    match /callsheetPersonnel/{personnelId} {
      allow read, write: if isAuthenticated();
    }
    match /standalonePersonnel/{personnelId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId
      );
      allow write: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid
      );
    }
    match /callsheetTemplates/{templateId} {
      allow read, write: if isAuthenticated();
    }
    match /callsheetPublishedCallSheets/{publishId} {
      allow read, write: if isAuthenticated();
    }
    match /publishedCallSheets/{publishId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /callsheetLinks/{linkId} {
      allow read: if true; 
      allow write: if isAuthenticated();
    }
    match /callsheetDailyRecords/{recordId} {
      allow read, write: if isAuthenticated();
      allow create: if isAuthenticated();
    }
    match /dailyCallSheetRecords/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) &&
         request.resource.data.userId == request.auth.uid) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) &&
         resource.data.userId == request.auth.uid) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        resource.data.userId == request.auth.uid
      );
    }
    match /dailyCallSheets/{recordId} {
      allow read, write: if isAuthenticated();
    }
    match /messageSessions/{sessionId} {
      allow read: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participantIds;
      allow read: if isAuthenticated() 
        && isOwnerOrAdmin()
        && belongsToOrganization(resource.data.organizationId);
      allow write: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participantIds;
      allow create: if isAuthenticated() 
        && belongsToOrganization(request.resource.data.organizationId)
        && request.auth.uid in request.resource.data.participantIds;
    }
    match /messages/{messageId} {
      allow read: if isAuthenticated() 
        && resource.data != null
        && belongsToOrganization(resource.data.organizationId);
      allow update, delete: if isAuthenticated() 
        && resource.data != null
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid == resource.data.senderId;
      allow read, update, delete: if isAuthenticated() 
        && isOwnerOrAdmin()
        && resource.data != null
        && belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() 
        && request.resource.data.organizationId != null
        && request.resource.data.messageSessionId != null
        && request.auth.uid == request.resource.data.senderId
        && (
          belongsToOrganization(request.resource.data.organizationId) ||
          (exists(/databases/$(database)/documents/messageSessions/$(request.resource.data.messageSessionId)) &&
           request.auth.uid in get(/databases/$(database)/documents/messageSessions/$(request.resource.data.messageSessionId)).data.participantIds &&
           belongsToOrganization(get(/databases/$(database)/documents/messageSessions/$(request.resource.data.messageSessionId)).data.organizationId))
        );
      allow create: if isAuthenticated() 
        && isOwnerOrAdmin()
        && request.resource.data.organizationId != null
        && belongsToOrganization(request.resource.data.organizationId);
    }
    match /userSessions/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.userId == userId;
      allow update: if isAuthenticated() 
        && request.auth.uid == userId
        && resource.data.userId == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    match /edlFiles/{fileId} {
      allow read: if isAuthenticated() && hasEDLConverterAccess();
      allow create: if isAuthenticated() && hasEDLConverterAccess();
      allow update: if isAuthenticated() && hasEDLConverterAccess();
      allow delete: if isAuthenticated() && hasEDLConverterAccess();
    }
    match /edlFileMetadata/{document} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    match /edlFileChunks/{document} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    match /edlProjects/{projectId} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    match /parsing-admin-users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin'])
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        isOwnerOrAdmin() ||
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    match /parsing-patterns/{patternId} {
      allow read: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        hasMinimumHierarchy(50) ||
        isOwnerOrAdmin()
      );
    }
    match /pattern-statistics/{statId} {
      allow read: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        hasMinimumHierarchy(50) ||
        isOwnerOrAdmin()
      );
    }
    match /pattern-submissions/{submissionId} {
      allow read: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
    }
    match /knowledge_base/{docId} {
      allow read: if isAuthenticated() && (
        resource.data.organizationId == 'global' ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    match /workflowActions/{actionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    match /_system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        hasAnyRole(['OWNER', 'ADMIN']) || 
        hasAnyOrgRole(['owner', 'admin']) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /_health/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        hasAnyRole(['OWNER', 'ADMIN']) || 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    match /projectData/{dataId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /mapLayouts/{mapLayoutId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /mapLocations/{mapLocationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /mapData/{mapDataId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /pbmProjects/{projectId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /pbmSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /pbmPayscales/{payscaleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /pbmDailyStatus/{statusId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /productionSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /user_timecards/{timecardId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /timecard_entries/{entryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /timecard_approvals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.employeeId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.employeeId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /timecard_templates/{templateId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /production_budgets/{budgetId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER'])) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /budget_line_items/{lineItemId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
    }
    match /budget_approvals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']) || resource.data.requestedBy == request.auth.uid) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.requestedBy == request.auth.uid || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /budget_templates/{templateId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
    }
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.submittedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.submittedBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || 
         resource.data.submittedBy == request.auth.uid ||
         hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER'])) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || 
         resource.data.submittedBy == request.auth.uid ||
         isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /expense_approvals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']) || 
         resource.data.requestedBy == request.auth.uid) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.requestedBy == request.auth.uid || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /purchase_orders/{poId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || 
         resource.data.requestedBy == request.auth.uid ||
         hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER'])) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || 
         resource.data.requestedBy == request.auth.uid ||
         isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' ||
         hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER'])) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /po_approvals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.requestedBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']) || 
         resource.data.requestedBy == request.auth.uid) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.requestedBy == request.auth.uid || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /payroll_batches/{batchId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' ||
         hasAnyOrgRole(['ACCOUNTANT', 'ADMIN', 'OWNER'])) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.status == 'draft' || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /payroll_entries/{entryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
    }
    match /financial_reports/{reportId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.generatedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.generatedBy == request.auth.uid ||
        getOrganizationId() == 'standalone' ||
        (hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER']))
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.generatedBy == request.auth.uid ||
         hasAnyOrgRole(['LINE_PRODUCER', 'ACCOUNTANT', 'ADMIN', 'OWNER'])) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        (resource.data.generatedBy == request.auth.uid || isOwnerOrAdmin()) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /schedulerEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /calendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canAccessProject(request.resource.data.projectId) ||
        request.resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /schedulerEventAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /notes/{noteId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    match /mediaFiles/{mediaFileId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /clipShowPitches/{pitchId} {
      allow read: if isAuthenticated() && (
        getOrganizationId() != '' ||
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && (
        (request.resource.data != null && request.resource.data.organizationId != null && belongsToOrganization(request.resource.data.organizationId)) ||
        (request.resource.data != null && request.resource.data.organizationId != null && canAccessLicensingData(request.resource.data.organizationId))
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId))
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    match /clipShowLicenses/{licenseId} {
      allow read: if isAuthenticated() && (
        hasClipShowProAccess() ||
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (resource.data == null && hasClipShowProAccess()) ||
        isOwnerOrAdmin()
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId) ||
                    (canAccessLicensingData(resource.data.organizationId) && 
                     canVerifyBlockchain() &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockchainMetadata', 'updatedAt']));
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /clipShowLicenseTemplates/{templateId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess()) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        canAccessLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
    }
    match /clipShowSignedDocuments/{documentId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess()) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        canAccessLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        (canAccessLicensingData(resource.data.organizationId) && 
         canVerifyBlockchain() &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockchainMetadata', 'updatedAt'])) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
    }
    match /clipShowLicenseEmailHistory/{emailId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess()) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        canAccessLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin()) ||
        isOwnerOrAdmin()
      );
    }
    match /clipShowStories/{storyId} {
      allow read: if isAuthenticated() && (
        request.auth.token.email == 'admin.clipshow@example.com' ||
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canAccessLicensingData(request.resource.data.organizationId)
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyLicensingData(resource.data.organizationId)
      );
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin())
      );
      match /scriptVersions/{versionId} {
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        allow read: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow create: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) && isOwnerOrAdmin() ||
            canModifyLicensingData(getParentStory().organizationId) && isOwnerOrAdmin()
          )) ||
          (hasClipShowProAccess() && isOwnerOrAdmin())
        );
      }
      match /cellVersions/{coordinate} {
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        allow read: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow create: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
      match /inlineComments/{commentId} {
        function getParentStorySafe() {
          return exists(/databases/$(database)/documents/clipShowStories/$(storyId)) 
            ? get(/databases/$(database)/documents/clipShowStories/$(storyId)).data 
            : null;
        }
        allow read: if isAuthenticated() && (
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canAccessLicensingData(getParentStorySafe().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '') ||
          isAuthenticated()
        );
        allow create: if isAuthenticated() && (
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canModifyLicensingData(getParentStorySafe().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '') ||
          (isAuthenticated() && getOrganizationId() != '')
        );
        allow update: if isAuthenticated() && (
          (resource.data.authorId == request.auth.uid) ||
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canModifyLicensingData(getParentStorySafe().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow delete: if isAuthenticated() && (
          (resource.data.authorId == request.auth.uid) ||
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canModifyLicensingData(getParentStorySafe().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
      match /trackedChanges/{changeId} {
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        allow read: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow create: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
      match /revisionChecklist/{itemId} {
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        allow read: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow create: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
    }
    match /clipShowShows/{showId} {
      allow read: if isAuthenticated() && (
        (getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /trashcan/{trashcanId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && (
          belongsToOrganization(resource.data.organizationId) ||
          canAccessLicensingData(resource.data.organizationId)
        )) ||
        hasClipShowProAccess() ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canModifyLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && (
          belongsToOrganization(resource.data.organizationId) ||
          canModifyLicensingData(resource.data.organizationId)
        )) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow update: if false;
    }
    match /clipShowSeasons/{seasonId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /clipShowComments/{commentId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId) && (
        resource.data.userId == request.auth.uid ||
        isOwnerOrAdmin()
      );
      allow delete: if canModifyLicensingData(resource.data.organizationId) && (
        resource.data.userId == request.auth.uid ||
        isOwnerOrAdmin()
      );
    }
    match /clipShowDocuments/{documentId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /clipShowScriptTemplates/{templateId} {
      allow read: if canAccessLicensingData(resource.data.organizationId) && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId)
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /clipShowLicensingSpecialists/{specialistId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId) && isOwnerOrAdmin();
      allow update: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    match /clipShowContacts/{contactId} {
      allow read: if isAuthenticated() && (
        (getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId);
    }
    match /clipShowNotes/{noteId} {
      allow read: if isAuthenticated() && (
        hasClipShowProAccess() ||
        (resource.data == null) ||
        (resource.data != null && resource.data.organizationId != null && (
          (resource.data.userId == request.auth.uid) ||
          canAccessLicensingData(resource.data.organizationId) ||
          isOwnerOrAdmin()
        ))
      );
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid && (
          canAccessLicensingData(request.resource.data.organizationId) ||
          (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
          (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
          isOwnerOrAdmin()
        )
      );
      allow update: if isAuthenticated() && (
        canAccessLicensingData(resource.data.organizationId) && (
          resource.data.userId == request.auth.uid ||
          isOwnerOrAdmin()
        )
      );
      allow delete: if isAuthenticated() && (
        canAccessLicensingData(resource.data.organizationId) && (
          resource.data.userId == request.auth.uid ||
          isOwnerOrAdmin()
        )
      );
    }
    match /clipShowEpisodes/{episodeId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/clipShowEpisodes/{episodeId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /scriptApprovals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/scriptApprovals/{approvalId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /accessLogs/{logId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/accessLogs/{logId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /Editor/{editorId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /airtableBackupSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isOwnerOrAdmin();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/airtableBackupSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /airtableRollbackLogs/{logId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isOwnerOrAdmin();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/airtableRollbackLogs/{logId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /cloudIntegrations/{integrationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/cloudIntegrations/{integrationId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /consentRecords/{consentId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/consentRecords/{consentId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.userId != null && 
         request.auth.uid == resource.data.userId) ||
        isOwnerOrAdmin()
      );
    }
    match /dataExports/{exportId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/dataExports/{exportId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.userId != null && 
         request.auth.uid == resource.data.userId) ||
        isOwnerOrAdmin()
      );
    }
    match /dataProcessingActivities/{activityId} {
      allow read: if isOwnerOrAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/dataProcessingActivities/{activityId} {
      allow read: if isOwnerOrAdmin();
    }
    match /dataProcessingLogs/{logId} {
      allow read: if isOwnerOrAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/dataProcessingLogs/{logId} {
      allow read: if isOwnerOrAdmin();
    }
    match /dataRetentionPolicies/{policyId} {
      allow read: if isAuthenticated();
      allow create: if isOwnerOrAdmin();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/dataRetentionPolicies/{policyId} {
      allow read: if isAuthenticated();
    }
    match /dataSubjectRequests/{requestId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/dataSubjectRequests/{requestId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.userId != null && 
         request.auth.uid == resource.data.userId) ||
        isOwnerOrAdmin()
      );
    }
    match /archivedData/{archiveId} {
      allow read: if isOwnerOrAdmin();
      allow create: if isOwnerOrAdmin();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/archivedData/{archiveId} {
      allow read: if isOwnerOrAdmin();
    }
    match /pitches/{pitchId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/pitches/{pitchId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /productionStories/{storyId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/productionStories/{storyId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /scriptSuggestions/{suggestionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/scriptSuggestions/{suggestionId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /clipShowProjects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canAccessLicensingData(request.resource.data.organizationId)
      );
      allow update, delete: if isAuthenticated() && 
                               resource.data != null &&
                               (canModifyLicensingData(resource.data.organizationId) || 
                                belongsToOrganization(resource.data.organizationId)) &&
                               (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid);
    }
    match /clipShowFolders/{folderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canModifyLicensingData(request.resource.data.organizationId)
      );
      allow update: if isAuthenticated() && 
                     resource.data != null &&
                     (belongsToOrganization(resource.data.organizationId) ||
                      canModifyLicensingData(resource.data.organizationId)) && (
                       isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid
                     );
      allow delete: if isAuthenticated() && 
                     resource.data != null &&
                     (belongsToOrganization(resource.data.organizationId) ||
                      canModifyLicensingData(resource.data.organizationId)) &&
                     (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid);
    }
    match /clipShowBudgetMetadata/{budgetId} {
      allow read: if canAccessLicensingData(resource.data.organizationId) && 
        canAccessProject(resource.data.projectId);
      allow write: if canModifyLicensingData(request.resource.data.organizationId) && 
        canModifyProject(request.resource.data.projectId);
    }
    match /clipShowIndexedFiles/{fileId} {
      allow read: if isAuthenticated() && (
          isOwnerOrAdmin() ||
        (hasIndexedFilesAccess()) ||
        (getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId))
      );
      allow create, update: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) && (
          isOwnerOrAdmin() ||
          hasPageWriteAccess('indexed-files') ||
          hasIndexedFilesAccess()
        )
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          isOwnerOrAdmin() ||
          hasPageWriteAccess('indexed-files') ||
          hasClipShowProAccess()
        )
      );
    }
    match /clipShowParsedFiles/{fileId} {
      allow read: if canAccessLicensingData(resource.data.organizationId) && 
        canAccessProject(resource.data.projectId);
      allow write: if canModifyLicensingData(request.resource.data.organizationId) && 
        canModifyProject(request.resource.data.projectId);
    }
    match /firebaseStorageFiles/{fileId} {
      allow read: if isAuthenticated() && (
        (getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && 
        request.resource.data.organizationId != null &&
        (belongsToOrganization(request.resource.data.organizationId) ||
         (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
         isOwnerOrAdmin());
      allow update, delete: if isAuthenticated() && 
        resource.data != null &&
        resource.data.organizationId != null &&
        (belongsToOrganization(resource.data.organizationId) ||
         isOwnerOrAdmin());
    }
    match /firebaseStorageFolders/{folderId} {
      allow read: if isAuthenticated() && (
        (getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && 
        request.resource.data.organizationId != null &&
        (belongsToOrganization(request.resource.data.organizationId) ||
         (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
         isOwnerOrAdmin());
      allow update, delete: if isAuthenticated() && 
        resource.data != null &&
        resource.data.organizationId != null &&
        (belongsToOrganization(resource.data.organizationId) ||
         isOwnerOrAdmin());
    }
    match /clipShowAlerts/{alertId} {
      allow read: if isAuthenticated() && (
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId) &&
         (request.auth.uid in resource.data.affectedUsers || isOwnerOrAdmin())) ||
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if false; 
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId) &&
         (request.auth.uid in resource.data.affectedUsers || isOwnerOrAdmin()) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'resolvedAt', 'resolvedBy', 'snoozedUntil', 'updatedAt']))
      );
      allow delete: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
    }
    match /clipShowAIEmbeddings/{embeddingId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId)) ||
        (hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if false; 
      allow update: if false; 
      allow delete: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
    }
    match /clipShowAITrainingData/{trainingId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (hasClipShowProAccess() && getOrganizationId() != '' && isOwnerOrAdmin())
      );
      allow create: if false; 
      allow update: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
      allow delete: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
    }
    match /clipShowAIActionLogs/{logId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (hasClipShowProAccess() && getOrganizationId() != '' && isOwnerOrAdmin())
      );
      allow create: if false; 
      allow update: if false;
      allow delete: if false;
    }
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && (
          belongsToOrganization(resource.data.organizationId) ||
          (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
          (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId)
        )) ||
        (getOrganizationId() != '' && hasClipShowProAccess())
      );
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants &&
        belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants &&
        belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        request.auth.uid == resource.data.createdBy &&
        belongsToOrganization(resource.data.organizationId);
      match /messages/{messageId} {
        function isParticipant() {
          let convData = get(/databases/$(database)/documents/conversations/$(conversationId)).data;
          let participants = convData.get('participants', []);
          return isAuthenticated() && (
            isOwnerOrAdmin() ||
            belongsToOrganization(convData.organizationId) ||
            (participants is list && request.auth.uid in participants) ||
            (request.auth.token.email == 'admin.clipshow@example.com' && 
             convData.organizationId == 'clip-show-pro-productions')
          );
        }
        allow read: if isAuthenticated() && isParticipant();
        allow create: if isAuthenticated() &&
          isParticipant() &&
          request.auth.uid == request.resource.data.senderId;
        allow update: if isAuthenticated() &&
          (
            isOwnerOrAdmin() ||
            request.auth.uid == resource.data.senderId ||
            (
              isParticipant() &&
              request.resource.data.diff(resource.data).affectedKeys().hasAll(['readBy']) &&
              request.resource.data.conversationId == resource.data.conversationId &&
              request.resource.data.senderId == resource.data.senderId
            )
          );
        allow delete: if isAuthenticated() &&
          (request.auth.uid == resource.data.senderId || isOwnerOrAdmin());
      }
      match /typingIndicators/{userId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        allow write: if isAuthenticated() &&
          request.auth.uid == userId &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    match /organizations/{orgId}/cloudIntegrations/{integrationId} {
      allow read: if belongsToOrganization(orgId) || 
                   (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions');
      allow create: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     isAuthenticated();
      allow update: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
      allow delete: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
    }
    match /organizations/{orgId}/indexedFiles/{fileId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && isAuthenticated();
      allow update, delete: if belongsToOrganization(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.indexedBy);
    }
    match /organizations/{orgId}/dropboxIndexedFiles/{fileId} {
      allow read: if belongsToOrganizationWithDocCheck(orgId);
      allow create: if belongsToOrganizationWithDocCheck(orgId) && isAuthenticated();
      allow update, delete: if belongsToOrganizationWithDocCheck(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.indexedBy);
    }
    match /organizations/{orgId}/boxIndexedFiles/{fileId} {
      allow read: if belongsToOrganizationWithDocCheck(orgId);
      allow create: if belongsToOrganizationWithDocCheck(orgId) && isAuthenticated();
      allow update, delete: if belongsToOrganizationWithDocCheck(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.indexedBy);
    }
    match /backboneIndexedFiles/{fileId} {
      allow read: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && 
        request.resource.data.organizationId != null &&
        (belongsToOrganization(request.resource.data.organizationId) ||
         (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
         isOwnerOrAdmin());
      allow update, delete: if isAuthenticated() && 
        resource.data != null && resource.data.organizationId != null &&
        (belongsToOrganization(resource.data.organizationId) ||
         (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
         isOwnerOrAdmin() ||
         request.auth.uid == resource.data.userId);
    }
    match /organizations/{orgId}/driveConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && 
        request.auth.uid == request.resource.data.userId;
      allow delete: if belongsToOrganization(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
    }
    match /organizations/{orgId}/boxConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          resource.data.connectedBy == request.auth.uid ||
          isOwnerOrAdmin()
        );
    }
    match /organizations/{orgId}/googleConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          resource.data.connectedBy == request.auth.uid ||
          isOwnerOrAdmin()
        );
    }
    match /organizations/{orgId}/dropboxConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          resource.data.connectedBy == request.auth.uid ||
          isOwnerOrAdmin()
        );
    }
    match /airtableCredentials/{credentialId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId) &&
                     request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       request.auth.uid == request.resource.data.userId;
      allow update: if isAuthenticated() && 
                       belongsToOrganization(resource.data.organizationId) &&
                       request.auth.uid == resource.data.userId;
      allow delete: if isAuthenticated() && 
                       belongsToOrganization(resource.data.organizationId) &&
                       request.auth.uid == resource.data.userId;
    }
    match /airtableIntegrationConfigs/{configId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       hasRole(['ADMIN', 'OWNER']);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               hasRole(['ADMIN', 'OWNER']);
    }
    match /airtableSyncStatus/{configId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if isAuthenticated() && 
                     belongsToOrganization(request.resource.data.organizationId) &&
                     (isOwnerOrAdmin() || hasAnyRole(['ADMIN', 'OWNER']));
    }
    match /airtableSyncHistory/{historyId} {
      allow read: if isAuthenticated() && (
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
    }
    match /airtableSyncMetadata/{metadataId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; 
    }
    match /airtableSyncQueue/{queueId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId);
      allow update, delete: if false; 
    }
    match /airtableSyncBatches/{batchId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; 
    }
    match /airtableFieldMappings/{mappingId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       hasRole(['ADMIN', 'OWNER']);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               hasRole(['ADMIN', 'OWNER']);
    }
    match /airtableWebhookQueue/{queueId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; 
    }
    match /airtableBackups/{backupId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; 
    }
    match /airtableAuditLog/{logId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId) &&
                     hasRole(['ADMIN', 'OWNER']);
      allow write: if false; 
    }
    match /airtableAccessControl/{ruleId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId) &&
                     hasRole(['ADMIN', 'OWNER']);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       hasRole(['ADMIN', 'OWNER']);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               hasRole(['ADMIN', 'OWNER']);
    }
    match /airtableValidationReports/{reportId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; 
    }
    match /airtableMigrationHistory/{historyId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId);
      allow update, delete: if false; 
    }
    match /organizations/{orgId}/integrationConfigs/{configId} {
      allow read: if belongsToOrganization(orgId) || 
                   (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions');
      allow create: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     isAuthenticated();
      allow update: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     isAuthenticated();
      allow delete: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     isAuthenticated();
    }
    match /organizations/{orgId}/scriptTemplates/{templateId} {
      allow read: if belongsToOrganization(orgId) || resource.data.isPublic == true;
      allow create: if belongsToOrganization(orgId) && isAuthenticated();
      allow update: if belongsToOrganization(orgId) && (
        isOwnerOrAdmin() || 
        request.auth.uid == resource.data.createdBy
      );
      allow delete: if belongsToOrganization(orgId) && (
        isOwnerOrAdmin() || 
        request.auth.uid == resource.data.createdBy
      );
    }
    match /organizations/{orgId}/emailSettings/{settingsId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow update: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    match /organizations/{orgId}/integrationSettings/{integrationId} {
      allow read: if (belongsToOrganization(orgId) || 
                       (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                    isOwnerOrAdmin();
      allow create: if (belongsToOrganization(orgId) || 
                         (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                      isOwnerOrAdmin();
      allow update: if (belongsToOrganization(orgId) || 
                         (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                      isOwnerOrAdmin();
      allow delete: if (belongsToOrganization(orgId) || 
                         (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                      isOwnerOrAdmin();
    }
    match /organizations/{orgId}/emailNotificationLogs/{logId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if true; 
      allow update: if false; 
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    match /automationFunctions/{functionId} {
      allow read: if isAuthenticated();
      allow write: if false; 
    }
    match /automationRules/{ruleId} {
      allow read: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId);
    }
    match /automationLogs/{logId} {
      allow read: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow create: if true; 
      allow update: if false; 
      allow delete: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId);
    }
    match /pageInfo/{pageId} {
      allow read: if true; 
      allow write: if isAuthenticated() && isOwnerOrAdmin();
    }
    match /userPagePermissions/{permissionId} {
      allow read: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(resource.data.organizationId) && (
          request.auth.uid == resource.data.userId ||
          getOrganizationId() == resource.data.organizationId
        )
      );
      allow create, update: if isAuthenticated() && (
        isOwnerOrAdmin() && belongsToOrganization(request.resource.data.organizationId)
      );
      allow delete: if isAuthenticated() && isOwnerOrAdmin();
    }
    match /organizations/{orgId}/slackConnections/{connectionId} {
      allow read: if isAuthenticated() && belongsToOrganization(orgId);
      allow create, update: if isAuthenticated() && belongsToOrganization(orgId) && (
        isOwnerOrAdmin() ||
        request.resource.data.type == 'user' && request.auth.uid == request.resource.data.userId
      );
      allow delete: if isAuthenticated() && belongsToOrganization(orgId) && (
        isOwnerOrAdmin() ||
        resource.data.type == 'user' && request.auth.uid == resource.data.userId
      );
    }
    match /organizations/{orgId}/slackChannels/{channelId} {
      allow read: if isAuthenticated() && belongsToOrganization(orgId);
      allow create, update: if isAuthenticated() && belongsToOrganization(orgId) && (
        isOwnerOrAdmin() ||
        request.auth.uid == request.resource.data.userId
      );
      allow delete: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      match /messages/{messageId} {
        allow read: if isAuthenticated() && belongsToOrganization(orgId);
        allow create, update: if isAuthenticated() && belongsToOrganization(orgId);
        allow delete: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      }
    }
    match /organizations/{orgId}/slackUsers/{userId} {
      allow read: if isAuthenticated() && belongsToOrganization(orgId);
      allow create, update: if isAuthenticated() && belongsToOrganization(orgId);
      allow delete: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    match /transcriptionTasks/{taskId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        belongsToOrganization(resource.data.organizationId)
      );
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid &&
        belongsToOrganization(request.resource.data.organizationId)
      );
      allow update: if false; 
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    match /organizations/{orgId}/projects/{projectId}/templates/{templateDocId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/grouped-clips/{groupId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/indexed-files/{indexedFilesDocId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/file-metadata/{fileId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/edl-files/{fileId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/edl-events/{eventId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/budget-values/{docId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/budget-groups/{docId} {
      allow read, write: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/budget-calculations/{docId} {
      allow read, write: if isAuthenticated() && (
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    match /organizations/{orgId}/projects/{projectId}/cue-sheets/{cueSheetId} {
      allow read: if isAuthenticated() && (
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone' ||
        (belongsToOrganization(orgId) && 
         canVerifyBlockchain() &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockchainMetadata', 'productionInfo', 'updatedAt', 'metadata']))
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /collaboration/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /organizations/{orgId}/aiApiKeys/{serviceId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow update: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    match /users/{userId}/aiApiKeys/{serviceId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    match /aiChatHistory/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      match /messages/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update, delete: if false;
      }
      match /savedChats/{chatId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    match /tenants/{orgId} {
      function belongsToTenantOrg() {
        return belongsToOrganization(orgId) || isOwnerOrAdmin();
      }
      match /projects/{projectId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg() && (
          canModifyProject(projectId) ||
          isOwnerOrAdmin()
        );
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
      match /projectTeamMembers/{assignmentId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg() && (
          (resource.data.projectId != null && canModifyProject(resource.data.projectId)) ||
          isOwnerOrAdmin()
        );
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
      match /project_participants/{participantId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg();
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
      match /datasets/{datasetId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg();
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
    }
    match /workflowTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/workflowTemplates/{templateId} {
      allow read: if isAuthenticated();
    }
    match /workflowInstances/{instanceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/workflowInstances/{instanceId} {
      allow read: if isAuthenticated();
    }
    match /workflowSteps/{stepId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/workflowSteps/{stepId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /workflow-templates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /workflow-instances/{instanceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /savedContainers/{containerId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/savedContainers/{containerId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /reviewSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/reviewSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /reviewSessionReviewers/{reviewerId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/reviewSessionReviewers/{reviewerId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /postProductionTasks/{taskId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/postProductionTasks/{taskId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /deliverables/{deliverableId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/deliverables/{deliverableId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /sessionAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/sessionAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /workflows/{workflowId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/workflows/{workflowId} {
      allow read: if isAuthenticated();
    }
    match /contacts/{contactId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/contacts/{contactId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /inventory/{inventoryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/inventory/{inventoryId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /userPreferences/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        request.auth.uid == userId ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/userPreferences/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isOwnerOrAdmin()
      );
    }
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/assignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /sessionWorkflows/{workflowId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/sessionWorkflows/{workflowId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /user-workflows/{workflowId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/user-workflows/{workflowId} {
      allow read: if isAuthenticated();
    }
    match /unifiedSessionSteps/{stepId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/unifiedSessionSteps/{stepId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /userDirectReports/{reportId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/userDirectReports/{reportId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /directReports/{reportId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/directReports/{reportId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /organizationMembers/{memberId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/organizationMembers/{memberId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /organizationSettings/{settingId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/organizationSettings/{settingId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /health-check/{checkId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isOwnerOrAdmin();
    }
    match /success/{statusId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /warning/{warningId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isOwnerOrAdmin();
    }
    match /brainMemory/{memoryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/brainMemory/{memoryId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /brainSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/brainSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /broadcasts/{broadcastId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/broadcasts/{broadcastId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /broadcast_viewers/{viewerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/broadcast_viewers/{viewerId} {
      allow read: if isAuthenticated();
    }
    match /chat/{chatId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/chat/{chatId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /edlStandaloneUsers/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/edlStandaloneUsers/{userId} {
      allow read: if isAuthenticated();
    }
    match /edlWorkspaces/{workspaceId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/edlWorkspaces/{workspaceId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /automationExecutions/{executionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/automationExecutions/{executionId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /sessionAutomations/{automationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/sessionAutomations/{automationId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /scheduledActions/{actionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/scheduledActions/{actionId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /qcSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/qcSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /reviewFilePaths/{pathId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/reviewFilePaths/{pathId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow create: if isOwnerOrAdmin();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/roles/{roleId} {
      allow read: if isAuthenticated();
    }
    match /securityAuditLogs/{logId} {
      allow read: if isOwnerOrAdmin();
      allow create: if isAuthenticated();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/securityAuditLogs/{logId} {
      allow read: if isOwnerOrAdmin();
    }
    match /sessionTracking/{trackingId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/sessionTracking/{trackingId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /tracking/{trackingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/tracking/{trackingId} {
      allow read: if isAuthenticated();
    }
    match /standaloneUsers/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        request.auth.uid == userId ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/standaloneUsers/{userId} {
      allow read: if isAuthenticated();
    }
    match /org_members/{memberId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/org_members/{memberId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /portfolios/{portfolioId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/portfolios/{portfolioId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /pbmAnalytics/{analyticsId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/pbmAnalytics/{analyticsId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /lifecycleRules/{ruleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isOwnerOrAdmin();
      allow update: if isOwnerOrAdmin();
      allow delete: if isOwnerOrAdmin();
    }
    match /{path=**}/lifecycleRules/{ruleId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /webrtc_signals/{signalId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /{path=**}/webrtc_signals/{signalId} {
      allow read: if isAuthenticated();
    }
    match /inventoryAssignmentHistory/{historyId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/inventoryAssignmentHistory/{historyId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /inventoryHistory/{historyId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/inventoryHistory/{historyId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /networkIPRanges/{rangeId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/networkIPRanges/{rangeId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /networks/{networkId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/networks/{networkId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /schemas/{schemaId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/schemas/{schemaId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /callSheetTemplates/{templateId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/callSheetTemplates/{templateId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /dailyRecords/{recordId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/dailyRecords/{recordId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /oauthStates/{stateId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/oauthStates/{stateId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.userId != null && 
         request.auth.uid == resource.data.userId) ||
        isOwnerOrAdmin()
      );
    }
    match /budgetValues/{valueId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /budgets/{budgetId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /checkoutRecords/{recordId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /clipPitches/{pitchId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /clipShowCalendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /cue-sheets/{sheetId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /cueSheets/{sheetId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /licenseAgreements/{agreementId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /locations/{locationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /musicFiles/{fileId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /networkDevices/{deviceId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /pattern-conflicts/{conflictId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isOwnerOrAdmin();
    }
    match /projectSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /scenes/{sceneId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /slackConnections/{connectionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /networkDeliveryBibles/{bibleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    match /{path=**}/networkDeliveryBibles/{bibleId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /inventorySchemas/{schemaId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    match /{path=**}/inventorySchemas/{schemaId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /networkIPAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{path=**}/networkIPAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        (resource != null && resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId)) ||
        getOrganizationId() == 'standalone' ||
        isOwnerOrAdmin()
      );
    }
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 
