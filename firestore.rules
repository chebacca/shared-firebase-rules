rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // ‚ö†Ô∏è SOURCE OF TRUTH - EDIT THIS FILE FOR ALL RULE UPDATES
    // ============================================================================
    // This is the PRIMARY file for Firestore security rules
    // 
    // For AI Assistants (LLMs/Cursor):
    // - ALWAYS edit this file (shared-firebase-rules/firestore.rules)
    // - DO NOT edit firestore.rules.local in project folders
    // - After editing, sync to local: cp firestore.rules ./firestore.rules.local
    // - Then deploy: firebase deploy --only firestore:rules
    //
    // See: shared-firebase-rules/README.md for full documentation
    // ============================================================================
    
    // ============================================================================
    // UNIFIED FIRESTORE SECURITY RULES - ALL PROJECTS
    // ============================================================================
    // Supports: Dashboard, Licensing Website, Call Sheet App, EDL Converter, Parser Brain, Clip Show Pro
    // Handles all collections with proper organization-based access control
    // Single source of truth for all Firebase security rules
    // ============================================================================
    
    // ============================================================================
    // HELPER FUNCTIONS (SIMPLIFIED)
    // ============================================================================
    
    // Authentication check
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user's custom claims
    function getUserClaims() {
      return request.auth.token;
    }
    
    // Get organization ID from user claims
    // ‚ö°Ô∏è OPTIMIZED: Relies strictly on Custom Claims derived by Cloud Functions
    function getOrganizationId() {
      return getUserClaims().get('organizationId', '');
    }
    
    // Check if user belongs to organization
    // ‚ö°Ô∏è OPTIMIZED: Relies strictly on Custom Claims
    function belongsToOrganization(organizationId) {
      return getOrganizationId() == organizationId || 
             organizationId in getUserClaims().get('allowedOrganizations', []);
    }
    
    // Check if user belongs to organization by also checking Firestore user document
    // Legacy support/Redundant check - kept for specific match rules if needed, but simplified
    function belongsToOrganizationWithDocCheck(organizationId) {
      return belongsToOrganization(organizationId);
    }
    
    // Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && getUserClaims().get('role', '') == role;
    }
    
    // Check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserClaims().get('role', '') in roles;
    }
    
    // Check if user has organizational role
    function hasOrgRole(role) {
       // Map legacy 'teamMemberRole' to 'role' or use 'role' directly if unified
       // Ideally role is unified in the claim, but keeping this check against claim is cheap
      return isAuthenticated() && (getUserClaims().get('role', '') == role || getUserClaims().get('teamMemberRole', '') == role);
    }
    
    // Check if user has any organizational roles
    function hasAnyOrgRole(roles) {
      return isAuthenticated() && (getUserClaims().get('role', '') in roles || getUserClaims().get('teamMemberRole', '') in roles);
    }
    
    // Check if user is owner or admin
    // ‚ö°Ô∏è OPTIMIZED: Relies on 'isOwnerOrAdmin' claim
    // Fallback to role check for safety
    function isOwnerOrAdmin() {
      return isAuthenticated() && (
        getUserClaims().get('isOwnerOrAdmin', false) ||
        hasAnyRole(['OWNER', 'ADMIN', 'SUPERADMIN', 'SUPER_ADMIN'])
      );
    }
    
    // Check if user owns the document (userId field matches)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user can access project data
    function canAccessProject(projectId) {
      return isAuthenticated() && (
        // Check if user has project assignment (Claim)
        projectId in getUserClaims().get('projectAssignments', {}) ||
        // Check if user belongs to organization (Efficient check now)
        // We still need to fetch the project to know its Org ID, this get() is unavoidable 
        // unless we store orgId in the projectAssignments claim map
        belongsToOrganization(get(/databases/$(database)/documents/projects/$(projectId)).data.organizationId) ||
        // Allow standalone users
        getOrganizationId() == 'standalone' ||
        // Allow admin users to access all projects
        isOwnerOrAdmin()
      );
    }
    
    // Check if user can modify project data
    function canModifyProject(projectId) {
      return isAuthenticated() && (
        // Check if user is project admin via Claim
        (projectId in getUserClaims().get('projectAssignments', {}) &&
         getUserClaims().get('projectAssignments', {})[projectId].get('baseRole', '') in ['ADMIN', 'DO_ER']) ||
        // Check if user has organization admin role via Claim
        (belongsToOrganization(get(/databases/$(database)/documents/projects/$(projectId)).data.organizationId) && isOwnerOrAdmin()) ||
        // Allow standalone users
        getOrganizationId() == 'standalone' ||
        // Allow admin users
        isOwnerOrAdmin()
      );
    }
    
    // Check if user has minimum hierarchy level
    function hasMinimumHierarchy(minLevel) {
      return isAuthenticated() && (
        getUserClaims().get('effectiveHierarchy', 0) >= minLevel ||
        getUserClaims().get('hierarchy', 0) >= minLevel
      );
    }
    
    // Check if user has EDL Converter access
    function hasEDLConverterAccess() {
      return isAuthenticated() && getUserClaims().get('isEDLConverter', false);
    }
    
    // Check if user has Call Sheet access
    function hasCallSheetAccess() {
      return isAuthenticated() && getUserClaims().get('isCallSheetUser', false);
    }
    
    // ============================================================================
    // WEB3 BLOCKCHAIN HELPER FUNCTIONS
    // ============================================================================
    
    // Get user's wallet addresses from claims
    function getWalletAddresses() {
      let addresses = getUserClaims().get('walletAddresses', []);
      // Support both array and single address formats
      return addresses.size() > 0 ? addresses : 
             (getUserClaims().get('walletAddress', '') != '' ? [getUserClaims().get('walletAddress', '')] : []);
    }
    
    // Check if user has a specific wallet address
    function hasWalletAddress(address) {
      return isAuthenticated() && address != '' && (
        getWalletAddresses().hasAny([address.lower()]) || 
        getWalletAddresses().hasAny([address])
      );
    }
    
    // Check if user can verify blockchain documents (has wallet or admin)
    function canVerifyBlockchain() {
      return isAuthenticated() && (
        getWalletAddresses().size() > 0 ||
        isOwnerOrAdmin()
      );
    }
    
    // Check if document was verified by user's wallet address
    function verifiedByUserWallet(documentData) {
      return isAuthenticated() && 
             documentData.get('blockchainMetadata', {}).get('verifiedBy', '') != '' &&
             getWalletAddresses().hasAny([documentData.get('blockchainMetadata', {}).get('verifiedBy', '').lower()]);
    }
    
    // Check if user is standalone user
    function isStandaloneUser() {
      return isAuthenticated() && getUserClaims().get('isStandaloneUser', false);
    }
    
    // Check if user has read access to a page based on permission matrix
    function hasPageReadAccess(pageId) {
      return isAuthenticated() && (
        // Admins have access to everything
        isOwnerOrAdmin() ||
        // Check page-level permission from custom claims
        getUserClaims().get('pagePermissions', {}).get('page:' + pageId + ':read', false) ||
        // Legacy: check if pagePermissions object exists as a flat object
        getUserClaims().get('page:' + pageId + ':read', false)
      );
    }
    
    // Check if user has write access to a page based on permission matrix
    function hasPageWriteAccess(pageId) {
      return isAuthenticated() && (
        // Admins have access to everything
        isOwnerOrAdmin() ||
        // Check flat format: page:{pageId}:write
        getUserClaims().get('page:' + pageId + ':write', false) ||
        // Check nested format: pagePermissions.{pageId}.write
        (getUserClaims().get('pagePermissions', {}) != null && 
         getUserClaims().get('pagePermissions', {}).get(pageId, {}) != null &&
         getUserClaims().get('pagePermissions', {}).get(pageId, {}).get('write', false))
      );
    }
    
    // Check if user has Clip Show Pro add-on access
    // ‚ö°Ô∏è OPTIMIZED: Relies on boolean Claim from Cloud Function
    function hasClipShowProAccess() {
      return isAuthenticated() && (
        getUserClaims().get('hasClipShowProAccess', false) ||
        isOwnerOrAdmin()
      );
    }
    
    // Check if user has Cue Sheet & CTC Budget Pro access
    // ‚ö°Ô∏è OPTIMIZED: Relies on boolean Claim from Cloud Function
    function hasCueSheetAccess() {
      return isAuthenticated() && (
        getUserClaims().get('hasCueSheetAccess', false) ||
        isOwnerOrAdmin()
      );
    }
    
    // Check if user has Parser Brain access
    // ‚ö°Ô∏è OPTIMIZED: Relies on permissions claim
    function hasParserBrainAccess() {
      return isAuthenticated() && (
        getUserClaims().get('parserBrainAccess', false) ||
        isOwnerOrAdmin() ||
        'PARSER_BRAIN' in getUserClaims().get('permissions', []) ||
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // Check if user has access to indexed files (either Clip Show Pro or Cue Sheet)
    function hasIndexedFilesAccess() {
      return hasClipShowProAccess() || hasCueSheetAccess();
    }
    
    // Check if user is a licensing specialist
    function isLicensingSpecialist() {
      return isAuthenticated() && (
        getUserClaims().get('role', '') == 'LICENSING_SPECIALIST' ||
        getUserClaims().get('isLicensingSpecialist', false) ||
        'licensing_specialist' in getUserClaims().get('permissions', [])
      );
    }
    
    // Check if user can access licensing data
    function canAccessLicensingData(organizationId) {
      return isAuthenticated() && (
        // Licensing specialists can access their organization's data
        (isLicensingSpecialist() && belongsToOrganization(organizationId)) ||
        // Admins can access all data
        isOwnerOrAdmin() ||
        // Users with Clip Show Pro access
        (hasClipShowProAccess() && belongsToOrganization(organizationId))
      );
    }
    
    // Check if user can modify licensing data
    function canModifyLicensingData(organizationId) {
      return isAuthenticated() && (
        // Licensing specialists can modify their organization's data
        (isLicensingSpecialist() && belongsToOrganization(organizationId)) ||
        // Admins can modify all data
        isOwnerOrAdmin() ||
        // Users with Clip Show Pro access and proper permissions
        (hasClipShowProAccess() && belongsToOrganization(organizationId) && 
         hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])) ||
        // Users with page-level write permissions for clearance or pitching
        (belongsToOrganization(organizationId) && (
          hasPageWriteAccess('clearance') ||
          hasPageWriteAccess('pitching')
        ))
      );
    }
    
    // ============================================================================
    // CROSS-APP SYNCHRONIZATION COLLECTIONS
    // ============================================================================
    
    // Role Sync Events - Cross-app role synchronization
    match /roleSyncEvents/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    // Data Sync Events - Cross-device data synchronization
    match /dataSyncEvents/{eventId} {
      // Users can read their own sync events
      // For collection queries: the query filter (where('userId', '==', auth.uid)) ensures users only see their own events
      // For document reads: check if document's userId matches authenticated user
      allow read: if isAuthenticated() && (
        // Admins can read all sync events
        isOwnerOrAdmin() ||
        // For document reads: check if document belongs to user
        (resource.data != null && resource.data.userId == request.auth.uid)
      );
      // Users can create sync events for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId != null &&
        (request.resource.data.userId == request.auth.uid || isOwnerOrAdmin());
      // Users can update/delete their own sync events
      allow update, delete: if isAuthenticated() && 
        resource.data != null &&
        (resource.data.userId == request.auth.uid || isOwnerOrAdmin());
    }
    
    // Project Assignments - Project assignment data
    match /projectAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId ||
        canAccessProject(resource.data.projectId)
      );
      allow write: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
    }
    
    // ============================================================================
    // CORE COLLECTIONS
    // ============================================================================
    
    // Users - Core user data
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (request.auth.uid == userId || isOwnerOrAdmin());
    }
    
    // Organizations - Organization data
    match /organizations/{orgId} {
      // Allow authenticated users to read (for queries) - client-side filtering ensures data isolation
      // Also check user document in Firestore if custom claims don't have organizationId
      allow read: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId) ||
        // Temporary: allow all authenticated users to read (for development/debugging)
        isAuthenticated()
      );
      // Document-level write protection
      allow write: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow create: if isAuthenticated() && isOwnerOrAdmin();
      allow update: if isAuthenticated() && belongsToOrganization(orgId) && isOwnerOrAdmin();
      
      // Encryption secret: Only organization members can read, only admins can write
      // Note: encryptionSecret field is protected by the above rules, but we document it here
      // The encryptionSecret field follows the same rules as the organization document
      
      // Call Sheet Projects - Projects for the standalone call sheet app
      match /callsheet-projects/{projectId} {
        // Allow authenticated users to read if they belong to the organization
        allow read: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          resource.data.ownerId == request.auth.uid ||
          request.auth.uid == resource.data.userId
        );
        // Allow create if user belongs to organization
        allow create: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          request.resource.data.ownerId == request.auth.uid ||
          request.resource.data.userId == request.auth.uid
        );
        // Allow update if user owns the project or belongs to organization
        allow update: if isAuthenticated() && (
          (belongsToOrganization(orgId) && isOwnerOrAdmin()) ||
          resource.data.ownerId == request.auth.uid ||
          request.auth.uid == resource.data.userId
        );
        // Allow delete if user owns the project or is admin
        allow delete: if isAuthenticated() && (
          (belongsToOrganization(orgId) && isOwnerOrAdmin()) ||
          resource.data.ownerId == request.auth.uid ||
          request.auth.uid == resource.data.userId
        );
      }
      
      // NLE Source Folders - NLE source folder configuration (subcollection)
      // For collection queries, allow if user belongs to organization (query filters by orgId in path)
      // For document reads, check if user belongs to organization
      match /nleSourceFolders/{folderId} {
        allow read: if isAuthenticated() && (
          // Allow collection queries: if user belongs to organization OR has Clip Show Pro access
          // The path already scopes to the organization (organizations/{orgId}/nleSourceFolders)
          // For collection queries (resource.data == null), allow if user belongs to org or has access
          (resource.data == null && (belongsToOrganization(orgId) || hasClipShowProAccess())) ||
          // Allow individual document reads: check if user belongs to organization OR has Clip Show Pro access
          (resource.data != null && (belongsToOrganization(orgId) || hasClipShowProAccess()))
        );
        allow create: if isAuthenticated() && (
          belongsToOrganization(orgId) && isOwnerOrAdmin()
        );
        allow update: if isAuthenticated() && (
          belongsToOrganization(orgId) && isOwnerOrAdmin()
        );
        allow delete: if isAuthenticated() && (
          belongsToOrganization(orgId) && isOwnerOrAdmin()
        );
        
        // NLE Source Folder Files - Subcollection for files within each folder
        match /files/{fileId} {
          // Allow access if the user belongs to the organization (folder is already under organizations/{orgId})
          allow read, write, create: if isAuthenticated() && 
            belongsToOrganization(orgId);
        }
      }
    }
    
    // Team Members - Team member data
    match /teamMembers/{memberId} {
      // üîß CRITICAL FIX: Allow authenticated users to read team members
      // This is needed for queries and for reading team member details when accessed through projectTeamMembers
      // Organization filtering happens client-side and in queries
      allow read: if isAuthenticated();
      // Document-level create protection
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      // Document-level update protection
      // Allow updates if:
      // 1. User is updating their own record AND belongs to organization, OR
      // 2. User is owner/admin (admins can update any team member - organization check is preferred but not required)
      allow update: if isAuthenticated() && (
        // User updating their own record
        (request.auth.uid == resource.data.userId && 
         belongsToOrganization(resource.data.organizationId)) ||
        // Admin/owner can update team members
        (isOwnerOrAdmin() && (
          belongsToOrganization(resource.data.organizationId) ||
          // Fallback: Verify user is a team member of this organization by checking teamMembers collection
          (exists(/databases/$(database)/documents/teamMembers/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/teamMembers/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
           // Global SuperAdmin override
           getUserClaims().get('role', '') in ['OWNER', 'ADMIN', 'SUPERADMIN', 'SUPER_ADMIN']
        ))
      );
      // Document-level delete protection
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Team Members - Project-specific team member assignments
    match /projectTeamMembers/{assignmentId} {
      // üîß CRITICAL FIX: Allow authenticated users to read project team member assignments
      // This allows queries by projectId and reading individual assignments
      // Organization and project access filtering happens client-side and in queries
      allow read: if isAuthenticated();
      // Document-level create protection
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      // Document-level update protection
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      // Document-level delete protection
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Team Members (snake_case) - Alternative collection name for Prisma schema compatibility
    match /project_team_members/{assignmentId} {
      // Allow authenticated users to read (for queries) - client-side filtering ensures data isolation
      // üîß CRITICAL FIX: Allow queries by allowing all authenticated reads, document-level checks happen on individual reads
      allow read: if isAuthenticated();
      // Document-level create protection
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      // Document-level update protection
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      // Document-level delete protection
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Contacts - Contact information (organization-scoped)
    match /contacts/{contactId} {
      // Allow authenticated users to read contacts
      // For collection queries: allow if user has organizationId in claims (query filter ensures correct org)
      // For document reads: check if document belongs to user's organization
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has an organizationId in claims, allow reads
        // The query filter will ensure users only see documents for their organization
        (getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Allow reads for users even if document doesn't exist yet (for real-time subscriptions)
        (resource.data == null && getOrganizationId() != '')
      );
      // Document-level create protection
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      // Document-level update protection
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      // Document-level delete protection
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Participants - Project participant assignments (primary collection)
    match /project_participants/{participantId} {
      // Allow authenticated users to read (for queries) - client-side filtering ensures data isolation
      allow read: if isAuthenticated();
      // Document-level create protection
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      // Document-level update protection
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          canModifyProject(resource.data.projectId) ||
          isOwnerOrAdmin()
        )
      );
      // Document-level delete protection
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Datasets - Project-dataset linking
    match /project_datasets/{linkId} {
      allow read: if isAuthenticated() && (
        // User can read if they belong to the same organization as the project
        belongsToOrganization(resource.data.organizationId) ||
        // User can read if they have project access
        canAccessProject(resource.data.projectId) ||
        // Allow ADMIN role users to read all project datasets
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
      allow write: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin();
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Datasets - Dataset metadata
    match /datasets/{datasetId} {
      allow read: if isAuthenticated() && (
        // User can read if they own the dataset
        request.auth.uid == resource.data.ownerId ||
        // User can read if they belong to the same organization
        belongsToOrganization(resource.data.organizationId) ||
        // User can read if they have access to projects that use this dataset
        canAccessProject(resource.data.projectId) ||
        // Allow ADMIN role users to read all datasets
        hasAnyRole(['ADMIN', 'SUPERADMIN', 'OWNER'])
      );
      allow write: if isAuthenticated() && (
        // User can write if they own the dataset
        request.auth.uid == resource.data.ownerId ||
        // User can write if they have organization admin rights
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    
    // Projects - Project data
    match /projects/{projectId} {
      // Allow read for authenticated users (queries filter by organizationId and projectAccess)
      allow read: if isAuthenticated() && (
        // üîß CRITICAL FIX: Allow admin.clipshow@example.com full access
        request.auth.token.email == 'admin.clipshow@example.com' ||
        // Allow all authenticated users (queries filter by organizationId)
        true
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && 
                     resource.data != null &&
                     canModifyProject(projectId);
      allow delete: if isAuthenticated() && 
                     resource.data != null &&
                     belongsToOrganization(resource.data.organizationId) && 
                     isOwnerOrAdmin();
    }
    
    // Folders - Project organization structure (regular folders)
    match /folders/{folderId} {
      // Allow read for authenticated users (queries filter by organizationId)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && (
        isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Folder Assignments - Maps projects to folders for organization
    match /projectFolderAssignments/{assignmentId} {
      // Allow read if document belongs to user's organization
      // For queries with where('organizationId', '==', orgId), Firestore validates
      // that all returned documents pass this check
      allow read: if isAuthenticated() && (
        // Document exists and belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Document doesn't exist yet (for real-time listeners) - allow if user has organization
        (resource.data == null && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
    }
    
    // Sessions - Production sessions
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    
    // Network Delivery Bibles - Network delivery configurations
    match /networkDeliveryBibles/{bibleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecards
    match /timecards/{timecardId} {
      allow read: if isOwner(resource.data.userId) || 
                     canAccessProject(resource.data.projectId);
      allow create: if canAccessProject(request.resource.data.projectId);
      allow update: if isOwner(resource.data.userId) || 
                       canModifyProject(resource.data.projectId);
    }
    
    // Timecard Templates
    match /timecardTemplates/{templateId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    
    // Workflow Templates (Unified)
    match /workflow-templates/{templateId} {
      // Allow authenticated users to read/write
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Workflow Instances (Unified) - kebab-case collection name
    match /workflow-instances/{instanceId} {
      // Allow authenticated users to read/write their own instances
      // Or if they belong to the organization
      allow read: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    
    // Workflow Instances (Unified) - camelCase collection name (alternative)
    match /workflowInstances/{instanceId} {
      // Allow authenticated users to read/write their own instances
      allow read: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        !('createdBy' in resource.data) ||
        resource.data.createdBy == request.auth.uid ||
        !('organizationId' in resource.data) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
    }
    
    // Timecard Assignments
    match /timecardAssignments/{assignmentId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    
    // Timecard Configurations
    match /timecardConfigurations/{configId} {
      allow read: if belongsToOrganization(resource.data.organizationId);
      allow create: if belongsToOrganization(request.resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow update: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin', 'manager']);
      allow delete: if belongsToOrganization(resource.data.organizationId) && 
                       hasAnyOrgRole(['owner', 'admin']);
    }
    
    // Inventory Items
    match /inventoryItems/{itemId} {
      // üîß FIX: Allow list operations for authenticated users (Parser Brain wrapper)
      allow list: if isAuthenticated();
      
      // Allow read (get) if user belongs to organization or has project access
      allow get: if isAuthenticated() && (
        (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        (resource.data.projectId != null && canAccessProject(resource.data.projectId)) ||
        (!('organizationId' in resource.data) || resource.data.organizationId == '' || resource.data.organizationId == null)
      );
      
      // Allow create if user belongs to organization
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(request.resource.data.organizationId) ||
        (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
        (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
      );
      
      // Allow update if user belongs to organization
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
        (resource.data.projectId != null && canModifyProject(resource.data.projectId))
      );
      
      // Allow delete if user is admin
      allow delete: if isAuthenticated() && isOwnerOrAdmin();
    }
    
    // Network IP Assignments - IP address assignments for inventory items
    match /networkIPAssignments/{assignmentId} {
      // üîß FIX: Allow list operations for authenticated users
      // The application code (GenericFirestoreAdapter) filters by organizationId,
      // so we allow authenticated users to query. Document-level rules below will enforce access.
      allow list: if isAuthenticated();
      
      // Allow read (get) if user belongs to organization (with fallback checks)
      // For list queries, Firestore evaluates this for each document, so we need to be permissive
      // but still check organization membership when possible
      allow get: if isAuthenticated() && (
        // Primary check: user's organization matches document's organization
        (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow if user can access the project
        (resource.data.projectId != null && canAccessProject(resource.data.projectId)) ||
        // Allow if organizationId is missing or empty (legacy documents or system documents)
        (!('organizationId' in resource.data) || resource.data.organizationId == '' || resource.data.organizationId == null)
      );
      
      // Allow create if user belongs to organization
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(request.resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == request.resource.data.organizationId) ||
        // Allow if user can access the project
        (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
      );
      
      // Allow update if user belongs to organization
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow if user can modify the project
        (resource.data.projectId != null && canModifyProject(resource.data.projectId))
      );
      
      // Allow delete if user belongs to organization and is admin
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
         // Fallback: allow if user document exists and has this organizationId
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId)) &&
        isOwnerOrAdmin()
      );
    }
    
    // Networks - Network definitions for IP management
    match /networks/{networkId} {
      // Allow read if user belongs to organization (with fallback checks)
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow if user can access the project
        (resource.data.projectId != null && canAccessProject(resource.data.projectId))
      );
      
      // Allow create if user belongs to organization
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(request.resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == request.resource.data.organizationId) ||
        // Allow if user can access the project
        (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
      );
      
      // Allow update if user belongs to organization
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow if user can modify the project
        (resource.data.projectId != null && canModifyProject(resource.data.projectId)) ||
        // Allow if user is the creator
        (resource.data.createdBy == request.auth.uid)
      );
      
      // Allow delete if user belongs to organization and is admin or creator
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
         // Fallback: allow if user document exists and has this organizationId
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId)) &&
        (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid)
      );
    }
    
    // Network IP Ranges - IP range definitions for networks
    match /networkIPRanges/{rangeId} {
      // Allow read if user belongs to organization (with fallback checks)
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow if user can access the project
        (resource.data.projectId != null && canAccessProject(resource.data.projectId))
      );
      
      // Allow create if user belongs to organization
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(request.resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == request.resource.data.organizationId) ||
        // Allow if user can access the project
        (request.resource.data.projectId != null && canAccessProject(request.resource.data.projectId))
      );
      
      // Allow update if user belongs to organization
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow if user can modify the project
        (resource.data.projectId != null && canModifyProject(resource.data.projectId)) ||
        // Allow if user is the creator
        (resource.data.createdBy == request.auth.uid)
      );
      
      // Allow delete if user belongs to organization and is admin or creator
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
         // Fallback: allow if user document exists and has this organizationId
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId)) &&
        (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid)
      );
    }
    
    // Schemas - Custom schema definitions for inventory and other collections
    match /schemas/{schemaId} {
      // üîß FIX: Allow list operations for authenticated users
      // The application code (GenericFirestoreAdapter) filters by organizationId,
      // so we allow authenticated users to query. Document-level rules below will enforce access.
      allow list: if isAuthenticated();
      
      // Allow read (get) if user belongs to organization (with fallback checks)
      // For list queries, Firestore evaluates this for each document, so we need to be permissive
      // but still check organization membership when possible
      allow get: if isAuthenticated() && (
        // Primary check: user's organization matches document's organization
        (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Allow public schemas
        resource.data.isPublic == true ||
        // Allow if organizationId is missing or empty (legacy documents or system documents)
        (!('organizationId' in resource.data) || resource.data.organizationId == '' || resource.data.organizationId == null)
      );
      
      // Allow create if user belongs to organization
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(request.resource.data.organizationId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == request.resource.data.organizationId) ||
        // Allow if user's organization matches
        (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId)
      );
      
      // Allow update if user belongs to organization
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
         // Fallback: allow if user document exists and has this organizationId
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
         // Allow if user's organization matches
         (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId)) &&
        (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid)
      );
      
      // Allow delete if user belongs to organization and is admin or creator
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
         // Fallback: allow if user document exists and has this organizationId
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
         // Allow if user's organization matches
         (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId)) &&
        (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid)
      );
    }
    
    // Reports
    match /reports/{reportId} {
      allow read: if canAccessProject(resource.data.projectId);
      allow create: if canAccessProject(request.resource.data.projectId);
      allow update: if isOwner(resource.data.userId) || 
                       canModifyProject(resource.data.projectId);
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId) || isOwnerOrAdmin();
      allow create: if true; // System can create notifications
      allow update: if isOwner(resource.data.userId) || isOwnerOrAdmin();
      allow delete: if isOwner(resource.data.userId) || isOwnerOrAdmin();
    }
    
    // Notification Preferences - User-specific notification category preferences
    match /notificationPreferences/{userId} {
      // Users can only read/write their own preferences
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Allow create if user is creating their own preferences
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow update if user is updating their own preferences
      allow update: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // User table view preferences - per-user table column configurations
    match /userTableViews/{userId} {
      // Users can only read/write their own table view preferences
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // Allow create if user is creating their own preferences
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow update if user is updating their own preferences
      allow update: if isAuthenticated() && request.auth.uid == userId;
      // Allow delete if user is deleting their own preferences
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================================================
    // LICENSING WEBSITE COLLECTIONS
    // ============================================================================
    
    // Licenses - Enhanced license validation with claims
    match /licenses/{licenseId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        (isAuthenticated() && resource.data.userId == request.auth.uid) ||
        isAuthenticated()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        (isAuthenticated() && request.resource.data.userId == request.auth.uid)
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin']) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // Subscriptions - Admin access for dashboard stats
    match /subscriptions/{subscriptionId} {
      // Allow authenticated users to read (for queries) - client-side filtering ensures data isolation
      // Also check user document in Firestore if custom claims don't have organizationId
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganizationWithDocCheck(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        // Fallback: allow if user document has this organizationId
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId) ||
        // Temporary: allow all authenticated users to read (for development)
        isAuthenticated()
      );
      // Document-level create protection
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) && 
         hasAnyOrgRole(['owner', 'admin'])) ||
        request.resource.data.userId == request.auth.uid
      );
      // Document-level update protection
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && 
         hasAnyOrgRole(['owner', 'admin'])) ||
        resource.data.userId == request.auth.uid
      );
      // Document-level delete protection
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // Standalone Licenses - Enhanced license validation
    match /standaloneLicenses/{licenseId} {
      allow read: if isAuthenticated() && (
        isAuthenticated() ||
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
      allow create: if isAuthenticated() && (
        isAuthenticated() && 
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['OWNER', 'ADMIN'])
      );
    }
    
    // Invoices - Organization billing invoices
    // Note: For collection queries to work, we need to allow queries where the user's orgId matches
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && (
        // Allow if user belongs to the organization OR
        belongsToOrganization(resource.data.organizationId) ||
        // Allow if user owns the invoice OR
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid ||
        // Allow admins/owners OR
        isOwnerOrAdmin() ||
        // Allow authenticated users - query will filter by organizationId
        (isAuthenticated() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin()) ||
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.firebaseUid == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        isOwnerOrAdmin()
      );
    }
    
    // Payments - Organization payment records
    // Note: For collection queries to work, we need to allow queries where the user's orgId matches
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && (
        // Allow if user belongs to the organization OR
        belongsToOrganization(resource.data.organizationId) ||
        // Allow if user owns the payment OR
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid ||
        // Allow admins/owners OR
        isOwnerOrAdmin() ||
        // Allow authenticated users - query will filter by organizationId
        (isAuthenticated() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) && isOwnerOrAdmin()) ||
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.firebaseUid == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        resource.data.userId == request.auth.uid ||
        resource.data.firebaseUid == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && 
        isOwnerOrAdmin()
      );
    }
    
    // Organization Members - Organization member records
    // Note: For collection queries to work, we need to allow queries where the user's orgId matches
    match /orgMembers/{memberId} {
      allow read: if isAuthenticated() && (
        // Allow if user belongs to the organization (check both field names) OR
        belongsToOrganization(resource.data.organizationId) ||
        belongsToOrganization(resource.data.orgId) ||
        // Allow if user owns the record OR
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.firebaseUid ||
        // Allow admins/owners OR
        isOwnerOrAdmin() ||
        // Allow authenticated users - query will filter by organizationId
        (isAuthenticated() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        belongsToOrganization(request.resource.data.orgId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        ((belongsToOrganization(resource.data.organizationId) ||
          belongsToOrganization(resource.data.orgId)) && isOwnerOrAdmin()) ||
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.firebaseUid
      );
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) ||
         belongsToOrganization(resource.data.orgId)) && 
        isOwnerOrAdmin()
      );
    }
    
    // ============================================================================
    // CALL SHEET APP COLLECTIONS
    // ============================================================================
    
    // Call sheets collection
    match /callsheetCallSheets/{callSheetId} {
      allow read, write: if isAuthenticated();
    }
    
    // Legacy callsheets collection (for dashboard integration)
    match /callsheets/{callSheetId} {
      allow read, write: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
    }
    
    // Call sheets collection (standalone app) - matches callSheets collection name
    match /callSheets/{callSheetId} {
      // Allow read for queries - client-side filtering ensures data isolation
      allow read: if isAuthenticated();
      // Document-level write protection
      allow write: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Personnel collection
    match /callsheetPersonnel/{personnelId} {
      allow read, write: if isAuthenticated();
    }
    
    // Standalone personnel collection (standalone app) - matches standalonePersonnel collection name
    match /standalonePersonnel/{personnelId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId
      );
      allow write: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        request.auth.uid == resource.data.userId
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Templates collection
    match /callsheetTemplates/{templateId} {
      allow read, write: if isAuthenticated();
    }
    
    // Published call sheets collection
    match /callsheetPublishedCallSheets/{publishId} {
      allow read, write: if isAuthenticated();
    }
    
    // Published call sheets collection (standalone app naming)
    // Allow public read access for published call sheets that are active
    // This allows real-time updates for public viewers
    // Note: Access code protection is handled at the application level via HTTP endpoints
    match /publishedCallSheets/{publishId} {
      // Allow read access for all published call sheets (access control via access code at app level)
      // This enables real-time subscriptions (onSnapshot) to work properly
      allow read: if true;
      // Allow write only for authenticated users
      allow write: if isAuthenticated();
    }
    
    // Call sheet links collection
    match /callsheetLinks/{linkId} {
      allow read: if true; // Public read access for published links
      allow write: if isAuthenticated();
    }
    
    // Daily call sheet records collection - user-specific access
    match /callsheetDailyRecords/{recordId} {
      allow read, write: if isAuthenticated();
      allow create: if isAuthenticated();
    }
    
    // Daily call sheet records collection (alternative naming)
    // Note: Queries filter by organizationId and userId, so we allow authenticated reads
    // The query itself ensures data isolation
    match /dailyCallSheetRecords/{recordId} {
      // Allow authenticated users to read - queries already filter by organizationId and userId
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        (belongsToOrganization(request.resource.data.organizationId) &&
         request.resource.data.userId == request.auth.uid) ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) &&
         resource.data.userId == request.auth.uid) ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) &&
        resource.data.userId == request.auth.uid
      );
    }
    
    // Legacy daily call sheets collection (for dashboard integration)
    match /dailyCallSheets/{recordId} {
      allow read, write: if isAuthenticated();
    }
    
    // Message sessions collection - for chat functionality
    match /messageSessions/{sessionId} {
      // Allow read (includes both get and list) for users who are participants
      allow read: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participantIds;
      // Allow admin users to read all message sessions in their organization
      allow read: if isAuthenticated() 
        && isOwnerOrAdmin()
        && belongsToOrganization(resource.data.organizationId);
      // Allow write for participants
      allow write: if isAuthenticated() 
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid in resource.data.participantIds;
      // Allow create for authenticated users in the organization
      allow create: if isAuthenticated() 
        && belongsToOrganization(request.resource.data.organizationId)
        && request.auth.uid in request.resource.data.participantIds;
    }
    
    // Messages collection - for chat messages
    match /messages/{messageId} {
      // Allow read if user belongs to organization (covers both senders and recipients)
      // The messageSessionId links to a conversation where user is a participant
      allow read: if isAuthenticated() 
        && resource.data != null
        && belongsToOrganization(resource.data.organizationId);
      
      // Allow write (update/delete) only if user is the sender
      allow update, delete: if isAuthenticated() 
        && resource.data != null
        && belongsToOrganization(resource.data.organizationId)
        && request.auth.uid == resource.data.senderId;
      
      // Allow admins to read/write all messages in their organization
      allow read, update, delete: if isAuthenticated() 
        && isOwnerOrAdmin()
        && resource.data != null
        && belongsToOrganization(resource.data.organizationId);
      
      // Allow create if user belongs to organization and is the sender
      // Also verify user is a participant in the message session for security
      allow create: if isAuthenticated() 
        && request.resource.data.organizationId != null
        && request.resource.data.messageSessionId != null
        && request.auth.uid == request.resource.data.senderId
        && (
          // User belongs to organization
          belongsToOrganization(request.resource.data.organizationId) ||
          // OR user is a participant in the message session (verify by reading session)
          (exists(/databases/$(database)/documents/messageSessions/$(request.resource.data.messageSessionId)) &&
           request.auth.uid in get(/databases/$(database)/documents/messageSessions/$(request.resource.data.messageSessionId)).data.participantIds &&
           belongsToOrganization(get(/databases/$(database)/documents/messageSessions/$(request.resource.data.messageSessionId)).data.organizationId))
        );
      
      // Allow admins to create messages in their organization
      allow create: if isAuthenticated() 
        && isOwnerOrAdmin()
        && request.resource.data.organizationId != null
        && belongsToOrganization(request.resource.data.organizationId);
    }
    
    // User Sessions - User session data for syncing across devices/tabs
    // Users can only read/write their own session data
    match /userSessions/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.userId == userId;
      allow update: if isAuthenticated() 
        && request.auth.uid == userId
        && resource.data.userId == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================================================
    // EDL CONVERTER COLLECTIONS
    // ============================================================================
    
    // EDL Files - EDL file data for standalone converter
    match /edlFiles/{fileId} {
      allow read: if isAuthenticated() && hasEDLConverterAccess();
      allow create: if isAuthenticated() && hasEDLConverterAccess();
      allow update: if isAuthenticated() && hasEDLConverterAccess();
      allow delete: if isAuthenticated() && hasEDLConverterAccess();
    }
    
    // EDL File Metadata - Metadata for chunked files
    match /edlFileMetadata/{document} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // EDL File Chunks - Chunked data for large files
    match /edlFileChunks/{document} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // EDL Projects - EDL project management
    match /edlProjects/{projectId} {
      allow read: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuthenticated() && hasEDLConverterAccess() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone' ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================================================
    // PARSER BRAIN COLLECTIONS
    // ============================================================================
    
    // Parser Brain Admin Users - Users with admin access to Parser Brain
    match /parsing-admin-users/{userId} {
      // Allow users to read their own admin user document
      // Also allow org owners and admins to read
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin'])
      );
      // Org owners/admins and users with parserBrainAccess can write
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        isOwnerOrAdmin() ||
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // Parsing patterns
    match /parsing-patterns/{patternId} {
      allow read: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        hasMinimumHierarchy(50) ||
        isOwnerOrAdmin()
      );
    }
    
    // Pattern statistics
    match /pattern-statistics/{statId} {
      allow read: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        hasMinimumHierarchy(50) ||
        isOwnerOrAdmin()
      );
    }
    
    // Pattern submissions
    match /pattern-submissions/{submissionId} {
      allow read: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
      allow write: if isAuthenticated() && (
        hasParserBrainAccess() ||
        hasAnyOrgRole(['owner', 'admin']) ||
        isOwnerOrAdmin()
      );
    }
    
    // ============================================================================
    // SYSTEM COLLECTIONS
    // ============================================================================
    
    // Workflow Actions - System workflow logging (non-critical)
    match /workflowActions/{actionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // System Configuration - Global system settings and collection metadata
    match /_system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        hasAnyRole(['OWNER', 'ADMIN']) || 
        hasAnyOrgRole(['owner', 'admin']) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Health Monitoring - System health and status
    match /_health/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        hasAnyRole(['OWNER', 'ADMIN']) || 
        hasAnyOrgRole(['owner', 'admin'])
      );
    }
    
    // ============================================================================
    // GENERIC COLLECTIONS
    // ============================================================================
    
    // Project Data - Project-specific data container
    match /projectData/{dataId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // MAP AND LAYOUT COLLECTIONS
    // ============================================================================
    
    // Map Layouts - Map layout definitions
    match /mapLayouts/{mapLayoutId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Map Locations - Map location data
    match /mapLocations/{mapLocationId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Map Data - General map data
    match /mapData/{mapDataId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // PBM (PROJECT BUDGET MANAGEMENT) COLLECTIONS
    // ============================================================================
    
    // PBM Projects - Project budget management
    match /pbmProjects/{projectId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // PBM Schedules - Budget schedules
    match /pbmSchedules/{scheduleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // PBM Payscales - Pay scale configurations
    match /pbmPayscales/{payscaleId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // PBM Daily Status - Daily status tracking
    match /pbmDailyStatus/{statusId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Production Sessions - Production session data
    match /productionSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // TIMECARD COLLECTIONS
    // ============================================================================
    
    // User Timecards - Main timecard records
    match /user_timecards/{timecardId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecard Entries - Individual clock in/out entries
    match /timecard_entries/{entryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecard Approvals - Approval workflow records
    match /timecard_approvals/{approvalId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.employeeId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.employeeId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Timecard Templates - Template configurations
    match /timecard_templates/{templateId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // SCHEDULER COLLECTIONS
    // ============================================================================
    
    // Scheduler Events - Calendar events and scheduling
    match /schedulerEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Calendar Events - Clip Show Pro calendar events with project-scoping
    match /calendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canAccessProject(resource.data.projectId) ||
        resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canAccessProject(request.resource.data.projectId) ||
        request.resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyProject(resource.data.projectId) ||
        resource.data.createdBy == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Scheduler Event Assignments - Event assignment data
    match /schedulerEventAssignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // NOTES COLLECTION
    // ============================================================================
    
    // Notes - User notes and annotations
    match /notes/{noteId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // MEDIA FILES COLLECTION
    // ============================================================================
    
    // Media files - organization-scoped with proper access control
    match /mediaFiles/{mediaFileId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Music files - organization-scoped with proper access control
    // Used by Cue Sheet & CTC Budget Tools and Parser Brain
    match /musicFiles/{musicFileId} {
      // Allow read for collection queries and individual document reads
      // For collection queries, allow if user has organizationId (query filters by organizationId)
      // For document reads, check if document belongs to user's organization
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has organizationId, allow reads
        // The query filter (where('organizationId', '==', this.organizationId)) ensures users only see documents for their organization
        getOrganizationId() != '' ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Allow reads for users who uploaded the file
        (resource.data != null && resource.data.uploadedBy == request.auth.uid) ||
        // Allow admins/owners
        isOwnerOrAdmin() ||
        // Allow standalone users
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        request.resource.data.uploadedBy == request.auth.uid ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) && (
          resource.data.uploadedBy == request.auth.uid ||
          isOwnerOrAdmin()
        ) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // CLIP SHOW PRO COLLECTIONS - ENHANCED FOR LICENSING SPECIALISTS
    // ============================================================================
    
    // Clip Show Pro Pitches - Pitch data for review
    match /clipShowPitches/{pitchId} {
      // Allow read if user belongs to organization OR has licensing access
      // Handle case where document might not exist yet or organizationId might be missing
      // For collection queries, allow if user has organizationId (query filters by organizationId)
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has organizationId, allow reads
        // The query filter (where('organizationId', '==', this.organizationId)) ensures users only see documents for their organization
        // This works for both Clip Show Pro users and organization members
        getOrganizationId() != '' ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // OR check if user has licensing access for this document
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && (
        (request.resource.data != null && request.resource.data.organizationId != null && belongsToOrganization(request.resource.data.organizationId)) ||
        (request.resource.data != null && request.resource.data.organizationId != null && canAccessLicensingData(request.resource.data.organizationId))
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId))
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    
    // Clip Show Pro Licenses - License agreements
    // Note: Supports blockchainMetadata field for document verification and immutability proof
    match /clipShowLicenses/{licenseId} {
      // Allow read for collection queries and individual document reads
      // For collection queries, allow if user has Clip Show Pro access (query filters by organizationId)
      // For document reads, check if document belongs to user's organization
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has Clip Show Pro access, allow reads
        // The query filter will ensure users only see documents for their organization
        // Note: We allow this even if getOrganizationId() is empty, as the query itself filters by organizationId
        hasClipShowProAccess() ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess()) ||
        // Fallback: Allow authenticated users to read if they're admin/owner
        isOwnerOrAdmin()
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      // Allow updates for blockchain verification if user has wallet address or has modify access
      allow update: if canModifyLicensingData(resource.data.organizationId) ||
                    (canAccessLicensingData(resource.data.organizationId) && 
                     canVerifyBlockchain() &&
                     // Only allow updating blockchainMetadata field
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockchainMetadata', 'updatedAt']));
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // License Templates - PDF templates for license agreements
    match /clipShowLicenseTemplates/{templateId} {
      // Allow read if user can access licensing data for the organization
      // Handle case where document might not exist yet or organizationId might be missing
      allow read: if isAuthenticated() && (
        // If document exists and has organizationId, check access
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // If user has Clip Show Pro access, allow reading (query filter will ensure correct organization)
        (hasClipShowProAccess()) ||
        // Admins have full access
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        canAccessLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
    }
    
    // Signed Documents - Uploaded signed PDF documents
    // Note: Supports blockchainMetadata field for cryptographic hash and verification data
    match /clipShowSignedDocuments/{documentId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess()) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        canAccessLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      // Allow updates for blockchain verification if user has wallet address or has modify access
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        (canAccessLicensingData(resource.data.organizationId) && 
         canVerifyBlockchain() &&
         // Only allow updating blockchainMetadata field
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockchainMetadata', 'updatedAt'])) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
    }
    
    // License Email History - Email sending history
    match /clipShowLicenseEmailHistory/{emailId} {
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess()) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        canAccessLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId)) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin()) ||
        isOwnerOrAdmin()
      );
    }
    
    // Clip Show Pro Stories - Production stories
    match /clipShowStories/{storyId} {
      // Allow read if user belongs to organization OR has licensing access
      // Handle case where document might not exist yet or organizationId might be missing
      // For collection queries, allow if user has Clip Show Pro access (they'll be filtered by organizationId in query)
      allow read: if isAuthenticated() && (
        // üîß CRITICAL FIX: Allow admin.clipshow@example.com full access
        request.auth.token.email == 'admin.clipshow@example.com' ||
        // Allow collection queries: if user has Clip Show Pro access and organizationId, allow reads
        // The query filter will ensure users only see documents for their organization
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // OR check if user has licensing access for this document
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      // Allow create if user belongs to organization OR has licensing access
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canAccessLicensingData(request.resource.data.organizationId)
      );
      // Allow update if user belongs to organization OR has licensing access
      allow update: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        canModifyLicensingData(resource.data.organizationId)
      );
      // Allow delete if user belongs to organization AND is admin OR has licensing access
      allow delete: if isAuthenticated() && (
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin())
      );
      
      // Script Versions subcollection - Version history for scripts
      match /scriptVersions/{versionId} {
        // Get parent story to check organization
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        
        // Allow read if user can access the parent story
        allow read: if isAuthenticated() && (
          // Check parent story organization
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          // Allow if user has Clip Show Pro access (for collection queries)
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow create if user can update the parent story
        allow create: if isAuthenticated() && (
          // Check parent story organization
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          // Allow if user has Clip Show Pro access
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow update if user can update the parent story (rare, but allowed for corrections)
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow delete if user is admin/owner (versions are typically immutable)
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) && isOwnerOrAdmin() ||
            canModifyLicensingData(getParentStory().organizationId) && isOwnerOrAdmin()
          )) ||
          (hasClipShowProAccess() && isOwnerOrAdmin())
        );
      }
      
      // Cell Versions subcollection - Version history for individual table cells
      match /cellVersions/{coordinate} {
        // Get parent story to check organization
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        
        // Allow read if user can access the parent story
        allow read: if isAuthenticated() && (
          // Check parent story organization
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          // Allow if user has Clip Show Pro access (for collection queries)
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow create if user can update the parent story
        allow create: if isAuthenticated() && (
          // Check parent story organization
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          // Allow if user has Clip Show Pro access
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow update if user can update the parent story (for updating versions array)
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow delete if user can update the parent story (for clearing cell history)
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
      
      // Inline Comments - Comments on specific text in scripts
      match /inlineComments/{commentId} {
        // Helper function to safely get parent story (returns null if can't access)
        function getParentStorySafe() {
          return exists(/databases/$(database)/documents/clipShowStories/$(storyId)) 
            ? get(/databases/$(database)/documents/clipShowStories/$(storyId)).data 
            : null;
        }
        
        // Allow read if user can access the parent story
        allow read: if isAuthenticated() && (
          // Try to check parent story organization (if accessible)
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canAccessLicensingData(getParentStorySafe().organizationId)
          )) ||
          // Fallback: allow if user has Clip Show Pro access
          (hasClipShowProAccess() && getOrganizationId() != '') ||
          // Allow authenticated users to read (will be filtered by queries)
          isAuthenticated()
        );
        
        // Allow create if user is authenticated and has Clip Show Pro access
        // The parent story check might fail, so we allow authenticated users with access
        allow create: if isAuthenticated() && (
          // First try to check parent story organization (if accessible)
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canModifyLicensingData(getParentStorySafe().organizationId)
          )) ||
          // Fallback: allow if user has Clip Show Pro access (most permissive)
          (hasClipShowProAccess() && getOrganizationId() != '') ||
          // Allow authenticated users with any organization access
          (isAuthenticated() && getOrganizationId() != '')
        );
        
        // Allow update if user is the comment author or can update the parent story
        allow update: if isAuthenticated() && (
          (resource.data.authorId == request.auth.uid) ||
          // Try to check parent story organization (if accessible)
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canModifyLicensingData(getParentStorySafe().organizationId)
          )) ||
          // Fallback: allow if user has Clip Show Pro access
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow delete if user is the comment author or can update the parent story
        allow delete: if isAuthenticated() && (
          (resource.data.authorId == request.auth.uid) ||
          // Try to check parent story organization (if accessible)
          (getParentStorySafe() != null && getParentStorySafe().organizationId != null && (
            belongsToOrganization(getParentStorySafe().organizationId) ||
            canModifyLicensingData(getParentStorySafe().organizationId)
          )) ||
          // Fallback: allow if user has Clip Show Pro access
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
      
      // Tracked Changes - Revision tracking for script changes
      match /trackedChanges/{changeId} {
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        
        // Allow read if user can access the parent story
        allow read: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow create if user can update the parent story (automatic change tracking)
        allow create: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow update if user can update the parent story (for accepting/rejecting changes)
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow delete if user can update the parent story (for clearing change history)
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
      
      // Revision Checklist - Requirements to address during revision
      match /revisionChecklist/{itemId} {
        function getParentStory() {
          return get(/databases/$(database)/documents/clipShowStories/$(storyId)).data;
        }
        
        // Allow read if user can access the parent story
        allow read: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canAccessLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow create if user can update the parent story (reviewers can create, writers can mark complete)
        allow create: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow update if user can update the parent story (writers can mark items complete)
        allow update: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
        
        // Allow delete if user can update the parent story (for removing checklist items)
        allow delete: if isAuthenticated() && (
          (getParentStory() != null && getParentStory().organizationId != null && (
            belongsToOrganization(getParentStory().organizationId) ||
            canModifyLicensingData(getParentStory().organizationId)
          )) ||
          (hasClipShowProAccess() && getOrganizationId() != '')
        );
      }
    }
    
    // Clip Show Pro Shows - Show management
    match /clipShowShows/{showId} {
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has an organizationId in claims, allow reads
        // The query filter will ensure users only see documents for their organization
        (getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Trashcan - Soft-deleted items for Clip Show Pro
    // Items are immutable once deleted - can only be read, created (soft delete), or deleted (restore/permanent delete)
    match /trashcan/{trashcanId} {
      // Allow read if user belongs to organization OR has Clip Show Pro access
      // For collection queries, allow if user has Clip Show Pro access (query filters by organizationId)
      allow read: if isAuthenticated() && (
        // Document read: check organization match
        (resource.data != null && resource.data.organizationId != null && (
          belongsToOrganization(resource.data.organizationId) ||
          canAccessLicensingData(resource.data.organizationId)
        )) ||
        // Collection query: allow if user has Clip Show Pro access (query will filter by organizationId)
        hasClipShowProAccess() ||
        // Admins have full access
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canModifyLicensingData(request.resource.data.organizationId) ||
        (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      allow delete: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null && (
          belongsToOrganization(resource.data.organizationId) ||
          canModifyLicensingData(resource.data.organizationId)
        )) ||
        (hasClipShowProAccess() && resource.data != null && belongsToOrganization(resource.data.organizationId)) ||
        isOwnerOrAdmin()
      );
      // Trashcan items are immutable - no updates allowed
      allow update: if false;
    }
    
    // Clip Show Pro Seasons - Season management
    match /clipShowSeasons/{seasonId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Clip Show Pro Comments - Pitch comments with mentions
    match /clipShowComments/{commentId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId) && (
        resource.data.userId == request.auth.uid ||
        isOwnerOrAdmin()
      );
      allow delete: if canModifyLicensingData(resource.data.organizationId) && (
        resource.data.userId == request.auth.uid ||
        isOwnerOrAdmin()
      );
    }
    
    // Clip Show Pro Documents - Document references (Google Docs, Box)
    match /clipShowDocuments/{documentId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Clip Show Pro Script Templates - Script templates
    match /clipShowScriptTemplates/{templateId} {
      allow read: if canAccessLicensingData(resource.data.organizationId) && (
        resource.data.isPublic == true ||
        belongsToOrganization(resource.data.organizationId)
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Clip Show Pro Licensing Specialists - Licensing specialist assignments
    match /clipShowLicensingSpecialists/{specialistId} {
      allow read: if canAccessLicensingData(resource.data.organizationId);
      allow create: if canAccessLicensingData(request.resource.data.organizationId) && isOwnerOrAdmin();
      allow update: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
      allow delete: if canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Clip Show Pro Contacts - Production contact management
    match /clipShowContacts/{contactId} {
      allow read: if isAuthenticated() && (
        // üîß CRITICAL FIX: Allow admin.clipshow@example.com full access
        request.auth.token.email == 'admin.clipshow@example.com' ||
        // Allow collection queries: if user has an organizationId in claims, allow reads
        // The query filter will ensure users only see documents for their organization
        (getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if canAccessLicensingData(request.resource.data.organizationId);
      allow update: if canModifyLicensingData(resource.data.organizationId);
      allow delete: if canModifyLicensingData(resource.data.organizationId);
    }
    
    // Clip Show Notes - User notes
    match /clipShowNotes/{noteId} {
      // Allow read if user belongs to organization and can access licensing data
      // Users can only read their own notes (filtered by userId in queries)
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has Clip Show Pro access, allow reads
        // The query filter will ensure users only see documents for their organization and userId
        hasClipShowProAccess() ||
        // Allow collection queries for authenticated users (query filters by userId and organizationId)
        // This is safe because the query itself enforces data isolation
        (resource.data == null) ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && (
          // User can read their own notes
          (resource.data.userId == request.auth.uid) ||
          // Or if they have licensing access
          canAccessLicensingData(resource.data.organizationId) ||
          // Or if they're admin/owner
          isOwnerOrAdmin()
        ))
      );
      // Users can create notes in their organization
      allow create: if isAuthenticated() && (
        // User must be creating a note for themselves
        request.resource.data.userId == request.auth.uid && (
          // Allow if they have licensing access
          canAccessLicensingData(request.resource.data.organizationId) ||
          // Or if they have Clip Show Pro access and belong to the organization
          (hasClipShowProAccess() && belongsToOrganization(request.resource.data.organizationId)) ||
          // Or if they have an organizationId in their token and it matches
          (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
          // Or if they're admin/owner
          isOwnerOrAdmin()
        )
      );
      // Users can only update their own notes (unless admin)
      allow update: if isAuthenticated() && (
        canAccessLicensingData(resource.data.organizationId) && (
          resource.data.userId == request.auth.uid ||
          isOwnerOrAdmin()
        )
      );
      // Users can only delete their own notes (unless admin)
      allow delete: if isAuthenticated() && (
        canAccessLicensingData(resource.data.organizationId) && (
          resource.data.userId == request.auth.uid ||
          isOwnerOrAdmin()
        )
      );
    }
    
    // ============================================================================
    // CLIP SHOW PRO PROJECT COLLECTIONS
    // ============================================================================
    
    // Projects collection - organization-scoped project metadata
    match /clipShowProjects/{projectId} {
      // Allow read if user belongs to organization OR has licensing access
      // Handle case where document might not exist yet or organizationId might be missing
      // For collection queries, allow if user has Clip Show Pro access (they'll be filtered by organizationId in query)
      allow read: if isAuthenticated() && (
        // üîß CRITICAL FIX: Allow admin.clipshow@example.com full access
        request.auth.token.email == 'admin.clipshow@example.com' ||
        // Allow collection queries: if user has Clip Show Pro access and organizationId, allow reads
        // The query filter will ensure users only see documents for their organization
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // OR check if user has licensing access for this document
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canAccessLicensingData(request.resource.data.organizationId)
      );
      allow update, delete: if isAuthenticated() && 
                               resource.data != null &&
                               (canModifyLicensingData(resource.data.organizationId) || 
                                belongsToOrganization(resource.data.organizationId)) &&
                               (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid);
    }
    
    // Folders collection - project organization structure (Clip Show Pro folders)
    match /clipShowFolders/{folderId} {
      // Allow read if user belongs to organization OR has licensing access
      // Handle case where document might not exist yet or organizationId might be missing
      // For collection queries, allow if user has Clip Show Pro access (they'll be filtered by organizationId in query)
      allow read: if isAuthenticated() && (
        // üîß CRITICAL FIX: Allow admin.clipshow@example.com full access
        request.auth.token.email == 'admin.clipshow@example.com' ||
        // Allow collection queries: if user has Clip Show Pro access and organizationId, allow reads
        // The query filter will ensure users only see documents for their organization
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // OR check if user has licensing access for this document
        (resource.data != null && resource.data.organizationId != null && canAccessLicensingData(resource.data.organizationId)) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        canModifyLicensingData(request.resource.data.organizationId)
      );
      allow update: if isAuthenticated() && 
                     resource.data != null &&
                     (belongsToOrganization(resource.data.organizationId) ||
                      canModifyLicensingData(resource.data.organizationId)) && (
                       isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid
                     );
      allow delete: if isAuthenticated() && 
                     resource.data != null &&
                     (belongsToOrganization(resource.data.organizationId) ||
                      canModifyLicensingData(resource.data.organizationId)) &&
                     (isOwnerOrAdmin() || resource.data.createdBy == request.auth.uid);
    }
    
    // Budget metadata collection - budget summaries and group metadata
    match /clipShowBudgetMetadata/{budgetId} {
      allow read: if canAccessLicensingData(resource.data.organizationId) && 
        canAccessProject(resource.data.projectId);
      allow write: if canModifyLicensingData(request.resource.data.organizationId) && 
        canModifyProject(request.resource.data.projectId);
    }
    
    // Indexed files collection - file/folder metadata for media indexing
    match /clipShowIndexedFiles/{fileId} {
      // Allow read if user belongs to organization AND has page:indexed-files:read permission
      // For collection queries, allow authenticated users (query filter ensures org isolation via where('organizationId', '==', orgId))
      // For individual document reads, check organization membership
      allow read: if isAuthenticated() && (
        // Admins have full access
          isOwnerOrAdmin() ||
        // For collection queries: allow if user has Clip Show Pro or Cue Sheet access
        // The query's where('organizationId', '==', orgId) filter ensures data isolation
        (hasIndexedFilesAccess()) ||
        // For collection queries: allow any authenticated user (query filter ensures org isolation)
        // This is needed for Cue Sheet users who may not have the access claim set yet
        // The where('organizationId', '==', orgId) in the query ensures users can only see their org's data
        (getOrganizationId() != '') ||
        // For individual document reads: check organization membership
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId))
      );
      
      // Allow create/update if user belongs to organization AND has page:indexed-files:write permission
      allow create, update: if isAuthenticated() && (
        // Check if user belongs to organization
        belongsToOrganization(request.resource.data.organizationId) && (
          // Admins have access to everything
          isOwnerOrAdmin() ||
          // Check permission matrix for indexed-files page write access
          hasPageWriteAccess('indexed-files') ||
          // Fallback: allow if user has Clip Show Pro or Cue Sheet access (for backward compatibility)
          hasIndexedFilesAccess()
        )
      );
      
      // Allow delete if user belongs to organization AND has page:indexed-files:write permission
      allow delete: if isAuthenticated() && (
        // Check if user belongs to organization
        belongsToOrganization(resource.data.organizationId) && (
          // Admins have access to everything
          isOwnerOrAdmin() ||
          // Check permission matrix for indexed-files page write access
          hasPageWriteAccess('indexed-files') ||
          // Fallback: allow if user has Clip Show Pro access (for backward compatibility)
          hasClipShowProAccess()
        )
      );
    }
    
    // Parsed files collection - EDL parsing metadata with Storage URLs
    match /clipShowParsedFiles/{fileId} {
      allow read: if canAccessLicensingData(resource.data.organizationId) && 
        canAccessProject(resource.data.projectId);
      allow write: if canModifyLicensingData(request.resource.data.organizationId) && 
        canModifyProject(request.resource.data.projectId);
    }
    
    // Firebase Storage Files - Native file uploads metadata
    // Stores metadata for files uploaded directly to Firebase Storage
    match /firebaseStorageFiles/{fileId} {
      // Allow read if user belongs to organization
      allow read: if isAuthenticated() && (
        // For collection queries: allow if user has organization ID
        (getOrganizationId() != '') ||
        // For document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId))
      );
      
      // Allow create if user belongs to organization (any authenticated org member can upload files)
      // More permissive: check if organizationId matches user's org OR if user is authenticated
      allow create: if isAuthenticated() && 
        request.resource.data.organizationId != null &&
        (belongsToOrganization(request.resource.data.organizationId) ||
         // Fallback: if user has organizationId in claims, allow if it matches
         (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
         // Additional fallback: allow if user is admin
         isOwnerOrAdmin());
      
      // Allow update/delete if user belongs to organization
      allow update, delete: if isAuthenticated() && 
        resource.data != null &&
        resource.data.organizationId != null &&
        (belongsToOrganization(resource.data.organizationId) ||
         // Fallback: allow if user is admin
         isOwnerOrAdmin());
    }
    
    // Firebase Storage Folders - Virtual folder structure for native uploads
    // Stores folder hierarchy metadata for organizing Firebase Storage files
    match /firebaseStorageFolders/{folderId} {
      // Allow read if user belongs to organization
      allow read: if isAuthenticated() && (
        // For collection queries: allow if user has organization ID
        (getOrganizationId() != '') ||
        // For document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId))
      );
      
      // Allow create if user belongs to organization (any authenticated org member can create folders)
      // More permissive: check if organizationId matches user's org OR if user is authenticated
      allow create: if isAuthenticated() && 
        request.resource.data.organizationId != null &&
        (belongsToOrganization(request.resource.data.organizationId) ||
         // Fallback: if user has organizationId in claims, allow if it matches
         (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
         // Additional fallback: allow if user is admin
         isOwnerOrAdmin());
      
      // Allow update/delete if user belongs to organization
      allow update, delete: if isAuthenticated() && 
        resource.data != null &&
        resource.data.organizationId != null &&
        (belongsToOrganization(resource.data.organizationId) ||
         // Fallback: allow if user is admin
         isOwnerOrAdmin());
    }
    
    // ============================================================================
    // AI & ALERT SYSTEM COLLECTIONS
    // ============================================================================
    
    // Clip Show Pro Alerts - Schedule-aware alerts generated by AI
    match /clipShowAlerts/{alertId} {
      // Allow read if user belongs to organization
      // For collection queries: allow if user has Clip Show Pro access (query filters by organizationId)
      // For document reads: allow if user is affected by alert or is admin
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user has Clip Show Pro access, allow reads
        // The query filter will ensure users only see documents for their organization
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        // Allow individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId) &&
         (request.auth.uid in resource.data.affectedUsers || isOwnerOrAdmin())) ||
        // Allow reads for users with Clip Show Pro access even if document doesn't exist yet
        // (needed for real-time subscriptions that may check permissions before document exists)
        (resource.data == null && hasClipShowProAccess() && getOrganizationId() != '')
      );
      
      // Only system (via Cloud Functions) can create alerts
      // Users cannot directly create alerts
      allow create: if false; // Alerts are created by Cloud Functions only
      
      // Allow update if user is affected by alert or is admin
      // Users can resolve/snooze their own alerts
      allow update: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId) &&
         (request.auth.uid in resource.data.affectedUsers || isOwnerOrAdmin()) &&
         // Only allow updating status, resolvedAt, resolvedBy, snoozedUntil fields
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'resolvedAt', 'resolvedBy', 'snoozedUntil', 'updatedAt']))
      );
      
      // Only admins can delete alerts
      allow delete: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
    }
    
    // AI Embeddings - Vector embeddings for RAG system
    match /clipShowAIEmbeddings/{embeddingId} {
      // Allow read if user belongs to organization
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId)) ||
        (hasClipShowProAccess() && getOrganizationId() != '')
      );
      
      // Only system (via Cloud Functions) can create/update embeddings
      // Users cannot directly modify embeddings
      allow create: if false; // Embeddings are created by Cloud Functions only
      allow update: if false; // Embeddings are updated by Cloud Functions only
      allow delete: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
    }
    
    // AI Training Data - Training examples for fine-tuning
    match /clipShowAITrainingData/{trainingId} {
      // Allow read if user belongs to organization and is admin
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (hasClipShowProAccess() && getOrganizationId() != '' && isOwnerOrAdmin())
      );
      
      // Only system (via Cloud Functions) can create training data
      allow create: if false; // Training data is created by Cloud Functions only
      
      // Only admins can update/delete training data
      allow update: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
      allow delete: if isAuthenticated() && 
        resource.data != null && 
        resource.data.organizationId != null &&
        canModifyLicensingData(resource.data.organizationId) && 
        isOwnerOrAdmin();
    }
    
    // AI Action Logs - Logs of AI-suggested action executions
    match /clipShowAIActionLogs/{logId} {
      // Allow read if user belongs to organization and is admin
      allow read: if isAuthenticated() && (
        (resource.data != null && resource.data.organizationId != null &&
         belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin()) ||
        (hasClipShowProAccess() && getOrganizationId() != '' && isOwnerOrAdmin())
      );
      
      // Only system (via Cloud Functions) can create action logs
      allow create: if false; // Action logs are created by Cloud Functions only
      
      // Logs are immutable - no updates or deletes
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================================
    // MESSAGING SYSTEM COLLECTIONS
    // ============================================================================
    
    // Conversations collection - messaging conversations between users
    match /conversations/{conversationId} {
      // Allow read if user belongs to organization (for queries)
      // Client-side filtering ensures only conversations where user is a participant are shown
      allow read: if isAuthenticated() && (
        // For collection queries: allow if user has organizationId in claims (query filter ensures correct org)
        // The query filter will ensure users only see documents for their organization
        (getOrganizationId() != '') ||
        // For individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Allow reads for users even if document doesn't exist yet (for real-time subscriptions)
        (resource.data == null && getOrganizationId() != '')
      );
      
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants &&
        belongsToOrganization(request.resource.data.organizationId);
      
      // Allow update if user is a participant
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants &&
        belongsToOrganization(resource.data.organizationId);
      
      allow delete: if isAuthenticated() &&
        request.auth.uid == resource.data.createdBy &&
        belongsToOrganization(resource.data.organizationId);
      
      // Messages subcollection - only participants can read/write
      match /messages/{messageId} {
        // Helper function to check if user is a participant
        // Helper function to check if user is a participant
        function isParticipant() {
          let convData = get(/databases/$(database)/documents/conversations/$(conversationId)).data;
          // Ensure participants is a list
          let participants = convData.get('participants', []);
          
          return isAuthenticated() && (
            // Admins can always access (check first for performance)
            isOwnerOrAdmin() ||
            // Check if user belongs to organization
            belongsToOrganization(convData.organizationId) ||
            // Check if user's Firebase UID is directly in participants
            (participants is list && request.auth.uid in participants) ||
            // Special handling for admin.clipshow@example.com
            (request.auth.token.email == 'admin.clipshow@example.com' && 
             convData.organizationId == 'clip-show-pro-productions')
          );
        }
        
        allow read: if isAuthenticated() && isParticipant();
        
        allow create: if isAuthenticated() &&
          isParticipant() &&
          request.auth.uid == request.resource.data.senderId;
        
        // Allow update if:
        // 1. User is the sender (for editing/deleting), OR
        // 2. User is a participant and updating readBy field (for marking as read)
        // 3. Admin users can update any message
        allow update: if isAuthenticated() &&
          (
            // Admins can update any message
            isOwnerOrAdmin() ||
            // User is the sender (for editing/deleting)
            request.auth.uid == resource.data.senderId ||
            // User is a participant and updating readBy field (for marking as read)
            (
              isParticipant() &&
              // Check that readBy is being updated
              request.resource.data.diff(resource.data).affectedKeys().hasAll(['readBy']) &&
              // Ensure critical fields don't change
              request.resource.data.conversationId == resource.data.conversationId &&
              request.resource.data.senderId == resource.data.senderId
            )
          );
        
        allow delete: if isAuthenticated() &&
          (request.auth.uid == resource.data.senderId || isOwnerOrAdmin());
      }
      
      // Typing indicators subcollection - only participants can read/write
      match /typingIndicators/{userId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        allow write: if isAuthenticated() &&
          request.auth.uid == userId &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    
    // ============================================================================
    // GOOGLE DRIVE INTEGRATION - ORGANIZATION-WIDE
    // ============================================================================
    
    // Cloud Integrations - OAuth tokens (encrypted) stored per organization
    match /organizations/{orgId}/cloudIntegrations/{integrationId} {
      allow read: if belongsToOrganization(orgId) || 
                   (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions');
      allow create: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     isAuthenticated();
      allow update: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
      allow delete: if (belongsToOrganization(orgId) || 
                        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                     (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
    }
    
    // Indexed Files - Shared across organization from all connected Google Drives
    match /organizations/{orgId}/indexedFiles/{fileId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && isAuthenticated();
      allow update, delete: if belongsToOrganization(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.indexedBy);
    }
    
    // Dropbox Indexed Files - Files indexed from Dropbox
    match /organizations/{orgId}/dropboxIndexedFiles/{fileId} {
      allow read: if belongsToOrganizationWithDocCheck(orgId);
      allow create: if belongsToOrganizationWithDocCheck(orgId) && isAuthenticated();
      allow update, delete: if belongsToOrganizationWithDocCheck(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.indexedBy);
    }
    
    // Box Indexed Files - Files indexed from Box
    match /organizations/{orgId}/boxIndexedFiles/{fileId} {
      allow read: if belongsToOrganizationWithDocCheck(orgId);
      allow create: if belongsToOrganizationWithDocCheck(orgId) && isAuthenticated();
      allow update, delete: if belongsToOrganizationWithDocCheck(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.indexedBy);
    }
    
    // Backbone Indexed Files - Unified indexed files collection (local + cloud metadata)
    // This collection stores indexed files and folders from all sources (local, cloud, etc.)
    match /backboneIndexedFiles/{fileId} {
      // Allow read if user is authenticated and:
      // - For collection queries: allow if user has organization ID (query filter ensures org isolation via where('organizationId', '==', orgId))
      // - For document reads: check if document belongs to user's organization
      allow read: if isAuthenticated() && (
        // Admins have full access
        isOwnerOrAdmin() ||
        // For collection queries: allow if user has organization ID
        // The query's where('organizationId', '==', orgId) filter ensures data isolation
        (getOrganizationId() != '') ||
        // For individual document reads: check if document belongs to user's organization
        (resource.data != null && resource.data.organizationId != null && 
         belongsToOrganization(resource.data.organizationId))
      );
      
      // Allow create if user is authenticated and belongs to the organization
      allow create: if isAuthenticated() && 
        request.resource.data.organizationId != null &&
        (belongsToOrganization(request.resource.data.organizationId) ||
         (getOrganizationId() != '' && getOrganizationId() == request.resource.data.organizationId) ||
         isOwnerOrAdmin());
      
      // Allow update/delete if user is authenticated and belongs to the organization
      allow update, delete: if isAuthenticated() && 
        resource.data != null && resource.data.organizationId != null &&
        (belongsToOrganization(resource.data.organizationId) ||
         (getOrganizationId() != '' && getOrganizationId() == resource.data.organizationId) ||
         isOwnerOrAdmin() ||
         request.auth.uid == resource.data.userId);
    }
    
    // Google Drive Connections - Track which team members have connected their Drive
    match /organizations/{orgId}/driveConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && 
        request.auth.uid == request.resource.data.userId;
      allow delete: if belongsToOrganization(orgId) && 
        (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
    }
    
    // Box Connections - OAuth connections for Box integration
    match /organizations/{orgId}/boxConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can create/update their own user-level connection
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          // Admin/Owner can create/update organization-level connections
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can delete their own connection
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          // User can delete connection they created
          resource.data.connectedBy == request.auth.uid ||
          // Admin/Owner can delete any connection
          isOwnerOrAdmin()
        );
    }
    
    // Google Drive Connections (new structure) - OAuth connections for Google Drive integration
    match /organizations/{orgId}/googleConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can create/update their own user-level connection
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          // Admin/Owner can create/update organization-level connections
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can delete their own connection
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          // User can delete connection they created
          resource.data.connectedBy == request.auth.uid ||
          // Admin/Owner can delete any connection
          isOwnerOrAdmin()
        );
    }
    
    // Dropbox Connections - OAuth connections for Dropbox integration
    match /organizations/{orgId}/dropboxConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can create/update their own user-level connection
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          // Admin/Owner can create/update organization-level connections
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can delete their own connection
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          // User can delete connection they created
          resource.data.connectedBy == request.auth.uid ||
          // Admin/Owner can delete any connection
          isOwnerOrAdmin()
        );
    }
    
    // Webex Connections - OAuth connections for Webex integration
    match /organizations/{orgId}/webexConnections/{connectionId} {
      allow read: if belongsToOrganization(orgId);
      allow create, update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can create/update their own user-level connection
          (request.resource.data.type == 'user' && request.resource.data.userId == request.auth.uid) ||
          // Admin/Owner can create/update organization-level connections
          (request.resource.data.type == 'organization' && isOwnerOrAdmin())
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can delete their own connection
          (resource.data.type == 'user' && resource.data.userId == request.auth.uid) ||
          // User can delete connection they created
          resource.data.connectedBy == request.auth.uid ||
          // Admin/Owner can delete any connection
          isOwnerOrAdmin()
        );
    }
    
    // Video Meetings - Video conferencing meetings (Google Meet, Webex)
    match /organizations/{orgId}/videoMeetings/{meetingId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && 
        isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update: if belongsToOrganization(orgId) && 
        isAuthenticated() && (
          // User can update meetings they created
          resource.data.createdBy == request.auth.uid ||
          // Admin/Owner can update any meeting
          isOwnerOrAdmin()
        );
      allow delete: if belongsToOrganization(orgId) && 
        isAuthenticated() && isOwnerOrAdmin();
    }
    
    // ============================================================================
    // AIRTABLE INTEGRATION SECURITY RULES
    // ============================================================================
    
    // Airtable credentials storage
    match /airtableCredentials/{credentialId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId) &&
                     request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       request.auth.uid == request.resource.data.userId;
      allow update: if isAuthenticated() && 
                       belongsToOrganization(resource.data.organizationId) &&
                       request.auth.uid == resource.data.userId;
      allow delete: if isAuthenticated() && 
                       belongsToOrganization(resource.data.organizationId) &&
                       request.auth.uid == resource.data.userId;
    }
    
    // Airtable integration configurations
    match /airtableIntegrationConfigs/{configId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       hasRole(['ADMIN', 'OWNER']);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               hasRole(['ADMIN', 'OWNER']);
    }
    
    // Airtable sync status - Organization-level sync status tracking
    match /airtableSyncStatus/{configId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if isAuthenticated() && 
                     belongsToOrganization(request.resource.data.organizationId) &&
                     (isOwnerOrAdmin() || hasAnyRole(['ADMIN', 'OWNER']));
    }
    
    // Airtable sync history - Track sync operations
    match /airtableSyncHistory/{historyId} {
      allow read: if isAuthenticated() && (
        // If user has Clip Show Pro access, allow reading (query filter will ensure correct organization)
        (hasClipShowProAccess() && getOrganizationId() != '') ||
        // If document exists and has organizationId, check access
        (resource.data != null && resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId))
      );
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               (isOwnerOrAdmin() || request.auth.uid == resource.data.userId);
    }
    
    // Airtable sync metadata
    match /airtableSyncMetadata/{metadataId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Airtable sync queue
    match /airtableSyncQueue/{queueId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId);
      allow update, delete: if false; // Only Firebase Functions can update/delete
    }
    
    // Airtable sync batches
    match /airtableSyncBatches/{batchId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Airtable field mappings
    match /airtableFieldMappings/{mappingId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       hasRole(['ADMIN', 'OWNER']);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               hasRole(['ADMIN', 'OWNER']);
    }
    
    // Airtable webhook queue
    match /airtableWebhookQueue/{queueId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Airtable backups
    match /airtableBackups/{backupId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Airtable audit logs
    match /airtableAuditLog/{logId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId) &&
                     hasRole(['ADMIN', 'OWNER']);
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Airtable access control rules
    match /airtableAccessControl/{ruleId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId) &&
                     hasRole(['ADMIN', 'OWNER']);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId) &&
                       hasRole(['ADMIN', 'OWNER']);
      allow update, delete: if isAuthenticated() && 
                               belongsToOrganization(resource.data.organizationId) &&
                               hasRole(['ADMIN', 'OWNER']);
    }
    
    // Airtable validation reports
    match /airtableValidationReports/{reportId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow write: if false; // Only Firebase Functions can write
    }
    
    // Airtable migration history
    match /airtableMigrationHistory/{historyId} {
      allow read: if isAuthenticated() && 
                     belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && 
                       belongsToOrganization(request.resource.data.organizationId);
      allow update, delete: if false; // Only Firebase Functions can update/delete
    }
    
    // ============================================================================
    // INTEGRATION SETTINGS COLLECTIONS
    // ============================================================================
    
    // Integration Configurations - External service integration configs
    // Allow authenticated users to manage their own integration configurations
    match /organizations/{orgId}/integrationConfigs/{configId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId) ||
        // Special case for admin.clipshow@example.com
        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId) ||
        // Special case for admin.clipshow@example.com
        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId) ||
        // Special case for admin.clipshow@example.com
        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId) ||
        // Special case for admin.clipshow@example.com
        (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')
      );
    }
    
    // Script Templates - Script generation templates
    match /organizations/{orgId}/scriptTemplates/{templateId} {
      allow read: if belongsToOrganization(orgId) || resource.data.isPublic == true;
      allow create: if belongsToOrganization(orgId) && isAuthenticated();
      allow update: if belongsToOrganization(orgId) && (
        isOwnerOrAdmin() || 
        request.auth.uid == resource.data.createdBy
      );
      allow delete: if belongsToOrganization(orgId) && (
        isOwnerOrAdmin() || 
        request.auth.uid == resource.data.createdBy
      );
    }
    
    // Email Settings - Email notification configurations
    match /organizations/{orgId}/emailSettings/{settingsId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow update: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    
    // Integration Settings - Legacy collection for Box/Dropbox credentials (temporary - migrating to integrationConfigs)
    match /organizations/{orgId}/integrationSettings/{integrationId} {
      allow read: if (belongsToOrganization(orgId) || 
                       (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                    isOwnerOrAdmin();
      allow create: if (belongsToOrganization(orgId) || 
                         (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                      isOwnerOrAdmin();
      allow update: if (belongsToOrganization(orgId) || 
                         (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                      isOwnerOrAdmin();
      allow delete: if (belongsToOrganization(orgId) || 
                         (request.auth.token.email == 'admin.clipshow@example.com' && orgId == 'clip-show-pro-productions')) && 
                      isOwnerOrAdmin();
    }
    
    // Email Notification Logs - Email send history
    match /organizations/{orgId}/emailNotificationLogs/{logId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if true; // Firebase Functions can create
      allow update: if false; // Read-only after creation
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    
    // ============================================================================
    // AUTOMATION MANAGEMENT COLLECTIONS
    // ============================================================================
    
    // Automation Functions - Available automation functions (read-only, seeded by admin)
    match /automationFunctions/{functionId} {
      allow read: if isAuthenticated();
      allow write: if false; // Read-only, seeded by admin
    }
    
    // Automation Rules - Organization-specific automation rules
    match /automationRules/{ruleId} {
      allow read: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow create: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId);
    }
    
    // Automation Logs - Execution history (created by Cloud Functions)
    match /automationLogs/{logId} {
      allow read: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow create: if true; // Written by Cloud Functions
      allow update: if false; // Read-only after creation
      allow delete: if isAuthenticated() && isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId);
    }
    
    // ============================================================================
    // PAGE INFORMATION COLLECTION
    // ============================================================================
    
    // Page Information - Help/documentation for each page
    // Allow read access to all users (including unauthenticated) since it's just documentation
    // Individual page access is controlled by the application logic
    match /pageInfo/{pageId} {
      allow read: if true; // Public read access - pageInfo is just help documentation
      // Only admins can write page info
      allow write: if isAuthenticated() && isOwnerOrAdmin();
    }
    
    // ============================================================================
    // PAGE PERMISSIONS MATRIX COLLECTION
    // ============================================================================
    
    // User Page Permissions - Permission matrix for Clip Show Pro pages
    match /userPagePermissions/{permissionId} {
      // Allow read if user belongs to organization
      allow read: if isAuthenticated() && (
        // Admins can read all permissions
        isOwnerOrAdmin() ||
        // Users can read their own permissions
        belongsToOrganization(resource.data.organizationId) && (
          request.auth.uid == resource.data.userId ||
          // Allow if user belongs to the same organization
          getOrganizationId() == resource.data.organizationId
        )
      );
      
      // Allow write if user is admin and belongs to organization
      allow create, update: if isAuthenticated() && (
        isOwnerOrAdmin() && belongsToOrganization(request.resource.data.organizationId)
      );
      
      // Allow delete if user is admin
      allow delete: if isAuthenticated() && isOwnerOrAdmin();
    }
    
    // ============================================================================
    // SLACK INTEGRATION COLLECTIONS
    // ============================================================================
    
    // Slack Connections - Organization-level Slack workspace connections
    match /organizations/{orgId}/slackConnections/{connectionId} {
      // Allow read if user belongs to organization (with fallback checks)
      allow read: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      );
      
      // Allow create/update if user belongs to organization and is owner or admin
      allow create, update: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      ) && (
        isOwnerOrAdmin() ||
        // Users can create their own user-level connections
        request.resource.data.type == 'user' && request.auth.uid == request.resource.data.userId
      );
      
      // Allow delete if user belongs to organization
      allow delete: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      ) && (
        isOwnerOrAdmin() ||
        // Users can delete their own user-level connections
        resource.data.type == 'user' && request.auth.uid == resource.data.userId
      );
    }
    
    // Slack Channels - Synced Slack channels for organization
    match /organizations/{orgId}/slackChannels/{channelId} {
      // Allow read if user belongs to organization (with fallback checks)
      allow read: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      );
      
      // Allow write if user belongs to organization and is owner or admin
      allow create, update: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      ) && (
        isOwnerOrAdmin() ||
        // Users can update their own channel preferences
        request.auth.uid == request.resource.data.userId
      );
      
      // Allow delete if user is admin
      allow delete: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      ) && isOwnerOrAdmin();
      
      // Slack Messages subcollection - Messages synced from Slack channels
      match /messages/{messageId} {
        // Allow read if user belongs to organization (with fallback checks)
        allow read: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          belongsToOrganizationWithDocCheck(orgId) ||
          // Fallback: allow if user document exists and has this organizationId
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
        );
        
        // Allow create/update if user belongs to organization
        // This allows syncing messages from Slack API to Firestore
        allow create, update: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          belongsToOrganizationWithDocCheck(orgId) ||
          // Fallback: allow if user document exists and has this organizationId
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
        );
        
        // Allow delete if user is admin
        allow delete: if isAuthenticated() && (
          belongsToOrganization(orgId) ||
          belongsToOrganizationWithDocCheck(orgId) ||
          // Fallback: allow if user document exists and has this organizationId
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
        ) && isOwnerOrAdmin();
      }
    }
    
    // Slack Users - Synced Slack users for organization
    match /organizations/{orgId}/slackUsers/{userId} {
      // Allow read if user belongs to organization (with fallback checks)
      allow read: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      );
      
      // Allow create/update if user belongs to organization
      // This allows syncing user presence and info from Slack API to Firestore
      allow create, update: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      );
      
      // Allow delete if user is admin
      allow delete: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        belongsToOrganizationWithDocCheck(orgId) ||
        // Fallback: allow if user document exists and has this organizationId
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId)
      ) && isOwnerOrAdmin();
    }
    
    // ============================================================================
    // TRANSCRIPTION TASKS - Async video transcription task queue
    // ============================================================================
    
    match /transcriptionTasks/{taskId} {
      // Users can read their own tasks
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        belongsToOrganization(resource.data.organizationId)
      );
      // Users can create tasks for their organization
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid &&
        belongsToOrganization(request.resource.data.organizationId)
      );
      // Only the system (via Cloud Functions) can update tasks
      // Users can't directly update tasks - they're updated by the background processor
      allow update: if false; // Cloud Functions update via admin SDK
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
    }
    
    // ============================================================================
    // CLIP SHOW PRO PROJECT-LEVEL COLLECTIONS (under organizations/{orgId}/projects/{projectId}/)
    // ============================================================================
    
    // Projects - Organization-scoped projects collection
    // Used by Cue Sheet & CTC Budget Tools and Parser Brain
    match /organizations/{orgId}/projects/{projectId} {
      // Allow read for collection queries and individual document reads
      // For collection queries, allow if user has organizationId (query filters by orgId in path)
      // For document reads, check if document belongs to user's organization
      allow read: if isAuthenticated() && (
        // Allow collection queries: if user belongs to organization, allow reads
        // The path already scopes to the organization (organizations/{orgId}/projects)
        // For collection queries (resource.data == null), allow if user belongs to org
        (resource.data == null && belongsToOrganization(orgId)) ||
        // Allow individual document reads: check if user belongs to organization
        (resource.data != null && belongsToOrganization(orgId)) ||
        // Allow admins/owners
        isOwnerOrAdmin() ||
        // Allow standalone users
        getOrganizationId() == 'standalone'
      );
      allow create: if isAuthenticated() && (
        belongsToOrganization(orgId) ||
        isOwnerOrAdmin() ||
        getOrganizationId() == 'standalone'
      );
      allow update: if isAuthenticated() && (
        belongsToOrganization(orgId) && (
          isOwnerOrAdmin() ||
          resource.data.createdBy == request.auth.uid ||
          resource.data.ownerId == request.auth.uid
        ) ||
        getOrganizationId() == 'standalone'
      );
      allow delete: if isAuthenticated() && (
        belongsToOrganization(orgId) && (
          isOwnerOrAdmin() ||
          resource.data.createdBy == request.auth.uid ||
          resource.data.ownerId == request.auth.uid
        ) ||
        getOrganizationId() == 'standalone'
      );
    }
    
    // Templates - Template definitions for Clip Show Pro (stored as single document)
    match /organizations/{orgId}/projects/{projectId}/templates/{templateDocId} {
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks
        isOwnerOrAdmin() ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId)
      );
    }
    
    // Grouped Clips - Budget groups/clips for Clip Show Pro
    match /organizations/{orgId}/projects/{projectId}/grouped-clips/{groupId} {
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks
        isOwnerOrAdmin() ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // Indexed Files - Indexed file metadata (stored as single document)
    match /organizations/{orgId}/projects/{projectId}/indexed-files/{indexedFilesDocId} {
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks
        isOwnerOrAdmin() ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId)
      );
    }
    
    // File Metadata - EDL file metadata with events
    match /organizations/{orgId}/projects/{projectId}/file-metadata/{fileId} {
      // For collection queries, allow if user has Clip Show Pro access and belongs to organization
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks (check this FIRST for performance)
        isOwnerOrAdmin() ||
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // EDL Files - EDL file records
    match /organizations/{orgId}/projects/{projectId}/edl-files/{fileId} {
      // For collection queries, allow if user has Clip Show Pro access and belongs to organization
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks (check this FIRST for performance)
        isOwnerOrAdmin() ||
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // EDL Events - EDL event records
    match /organizations/{orgId}/projects/{projectId}/edl-events/{eventId} {
      // For collection queries, allow if user has Clip Show Pro access and belongs to organization
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks (check this FIRST for performance)
        isOwnerOrAdmin() ||
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // Budget Values - Budget value calculations
    match /organizations/{orgId}/projects/{projectId}/budget-values/{docId} {
      // For collection queries, allow if user has Clip Show Pro access and belongs to organization
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks (check this FIRST for performance)
        isOwnerOrAdmin() ||
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // Budget Groups - Budget group data (same as grouped-clips but different storage key)
    match /organizations/{orgId}/projects/{projectId}/budget-groups/{docId} {
      // For collection queries, allow if user has Clip Show Pro access and belongs to organization
      allow read, write: if isAuthenticated() && (
        // Admins have full access - bypass all checks (check this FIRST for performance)
        isOwnerOrAdmin() ||
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // Budget Calculations - Budget calculation results
    match /organizations/{orgId}/projects/{projectId}/budget-calculations/{docId} {
      // For collection queries, allow if user has Clip Show Pro access and belongs to organization
      allow read, write: if isAuthenticated() && (
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Admins have full access - bypass all checks
        isOwnerOrAdmin() ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Licensing specialists with Clip Show Pro access can access their organization's data
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        (isLicensingSpecialist() && hasClipShowProAccess() && getOrganizationId() == orgId)
      );
    }
    
    // Note: Supports blockchainMetadata field for document verification and immutability proof
    match /organizations/{orgId}/projects/{projectId}/cue-sheets/{cueSheetId} {
      // Allow read if user has Clip Show Pro access and belongs to organization
      allow read: if isAuthenticated() && (
        // If user has Clip Show Pro access and belongs to organization, allow collection queries
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        // Admins have full access - bypass all checks
        isOwnerOrAdmin() ||
        // Organization members can access their org's projects
        belongsToOrganization(orgId) ||
        // Allow standalone users
        getOrganizationId() == 'standalone'
      );
      // Allow create if user belongs to organization
      allow create: if isAuthenticated() && (
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone'
      );
      // Allow updates for blockchain verification if user has wallet address or has modify access
      allow update: if isAuthenticated() && (
        // Full update access
        (hasClipShowProAccess() && belongsToOrganization(orgId)) ||
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone' ||
        // Blockchain verification update (only blockchainMetadata field)
        (belongsToOrganization(orgId) && 
         canVerifyBlockchain() &&
         // Only allow updating blockchainMetadata and related fields
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockchainMetadata', 'productionInfo', 'updatedAt', 'metadata']))
      );
      allow delete: if isAuthenticated() && (
        isOwnerOrAdmin() ||
        belongsToOrganization(orgId) ||
        getOrganizationId() == 'standalone'
      );
    }

    // ============================================================================
    // COLLECTION GROUP QUERIES SUPPORT
    // ============================================================================

    // üîß FIX: Collection Group Query support for cue-sheets
    // Required for Parser Brain's "Scan" functionality and cross-project views
    match /{path=**}/cue-sheets/{cueSheetId} {
      allow read: if isAuthenticated() && (
        // Allow if user belongs to the organization specified in the document
        (resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Allow if user belongs to the organization of the parent project (if available)
        // Note: For collection group queries, we primarily rely on the data check above
        
        // Admin override
        isOwnerOrAdmin() ||
        
        // Standalone user override
        getOrganizationId() == 'standalone'
      );
    }

    // üîß FIX: Collection Group Query support for timecards
    // Required for Parser Brain and TimeCard wrappers to find timecards across projects
    match /{path=**}/timecards/{timecardId} {
      allow read: if isAuthenticated() && (
        // Allow if user belongs to the organization specified in the document
        (resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Check project access if projectId is present
        (resource.data.projectId != null && canAccessProject(resource.data.projectId)) ||
        // User's own timecards
        (resource.data.userId == request.auth.uid) ||
        // Admin override
        isOwnerOrAdmin() ||
        // Standalone user override
        getOrganizationId() == 'standalone'
      );
    }
    
    // üîß FIX: Collection Group Query support for calendarEvents
    // Required for Calendar wrappers to aggregate events
    match /{path=**}/calendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        // Organization access
        (resource.data.organizationId != null && belongsToOrganization(resource.data.organizationId)) ||
        // Project access
        (resource.data.projectId != null && canAccessProject(resource.data.projectId)) ||
        // User's own events
        (resource.data.createdBy == request.auth.uid) ||
        // Admin override
        isOwnerOrAdmin() ||
        // Standalone user override
        getOrganizationId() == 'standalone'
      );
    }
    
    // ============================================================================
    // COLLABORATION & REAL-TIME SYNC COLLECTIONS
    // ============================================================================
    
    // Collaboration - Real-time collaborative editing sync
    // Used by Yjs FirebaseProvider for peer-to-peer document synchronization
    match /collaboration/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================================================
    // AI API KEYS SECURITY RULES
    // ============================================================================
    
    // Organization-level AI API Keys
    match /organizations/{orgId}/aiApiKeys/{serviceId} {
      allow read: if belongsToOrganization(orgId);
      allow create: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow update: if belongsToOrganization(orgId) && isOwnerOrAdmin();
      allow delete: if belongsToOrganization(orgId) && isOwnerOrAdmin();
    }
    
    // User-level AI API Key overrides
    match /users/{userId}/aiApiKeys/{serviceId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // AI Chat History - Per user chat history storage
    match /aiChatHistory/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        // No update or delete - messages are immutable
        allow update, delete: if false;
      }
      
      // Saved Chats subcollection - Individual saved chat sessions
      match /savedChats/{chatId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated() && request.auth.uid == userId;
        allow update: if isAuthenticated() && request.auth.uid == userId;
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // ============================================================================
    // TENANT-SCOPED COLLECTIONS
    // ============================================================================
    // Collections scoped under tenants/{orgId}/... for organization isolation
    // These rules allow authenticated users to access collections under their organization's tenant path
    
    match /tenants/{orgId} {
      // Helper function to check if user belongs to this tenant organization
      function belongsToTenantOrg() {
        return belongsToOrganization(orgId) || isOwnerOrAdmin();
      }
      
      // Projects - Tenant-scoped projects collection
      match /projects/{projectId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg() && (
          canModifyProject(projectId) ||
          isOwnerOrAdmin()
        );
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
      
      // Project Team Members - Tenant-scoped project team member assignments
      match /projectTeamMembers/{assignmentId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg() && (
          // Allow if user can modify the project or is admin
          (resource.data.projectId != null && canModifyProject(resource.data.projectId)) ||
          isOwnerOrAdmin()
        );
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
      
      // Project Participants - Tenant-scoped project participants
      match /project_participants/{participantId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg();
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
      
      // Datasets - Tenant-scoped datasets
      match /datasets/{datasetId} {
        allow read: if belongsToTenantOrg();
        allow create: if belongsToTenantOrg();
        allow update: if belongsToTenantOrg();
        allow delete: if belongsToTenantOrg() && isOwnerOrAdmin();
      }
    }
    
    
    // ============================================================================
    // COLLECTION GROUP QUERY RULES
    // ============================================================================
    // These rules apply to collection group queries (queries across all subcollections with the same name)
    // Required for Universal Search Service and relationship graph queries
    
    // Team Members - Collection group query support
    match /{document=**}/teamMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        belongsToOrganization(request.resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow update: if isAuthenticated() && (
        (request.auth.uid == resource.data.userId && 
         belongsToOrganization(resource.data.organizationId)) ||
        (isOwnerOrAdmin() && belongsToOrganization(resource.data.organizationId))
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Timecards - Collection group query support
    match /{document=**}/timecards/{timecardId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin())
      );
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Call Sheets - Collection group query support
    match /{document=**}/callSheets/{callSheetId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Clip Pitches - Collection group query support
    match /{document=**}/clipPitches/{pitchId} {
      allow read: if isAuthenticated() && (
        hasClipShowProAccess() ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Production Stories - Collection group query support
    match /{document=**}/productionStories/{storyId} {
      allow read: if isAuthenticated() && (
        hasClipShowProAccess() ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Cue Sheets - Collection group query support
    match /{document=**}/cueSheets/{cueSheetId} {
      allow read: if isAuthenticated() && (
        hasCueSheetAccess() ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Budget Values - Collection group query support
    match /{document=**}/budgetValues/{budgetId} {
      allow read: if isAuthenticated() && (
        hasCueSheetAccess() ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Project Sessions - Collection group query support
    match /{document=**}/projectSessions/{sessionId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // License Agreements - Collection group query support
    match /{document=**}/licenseAgreements/{agreementId} {
      allow read: if isAuthenticated() && (
        hasClipShowProAccess() ||
        belongsToOrganization(resource.data.organizationId) ||
        canAccessLicensingData(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && canModifyLicensingData(resource.data.organizationId);
      allow delete: if isAuthenticated() && canModifyLicensingData(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Inventory Assets - Collection group query support
    match /{document=**}/inventory/{inventoryId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Calendar Events (Backbone Pro) - Collection group query support
    match /{document=**}/calendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // Calendar Events (Clip Show Pro) - Collection group query support
    match /{document=**}/clipShowCalendarEvents/{eventId} {
      allow read: if isAuthenticated() && (
        hasClipShowProAccess() ||
        belongsToOrganization(resource.data.organizationId) ||
        isOwnerOrAdmin()
      );
      allow create: if isAuthenticated() && belongsToOrganization(request.resource.data.organizationId);
      allow update: if isAuthenticated() && belongsToOrganization(resource.data.organizationId);
      allow delete: if isAuthenticated() && belongsToOrganization(resource.data.organizationId) && isOwnerOrAdmin();
    }
    
    // ============================================================================
    // CATCH-ALL RULE
    // ============================================================================
    
    // Explicit deny for unmatched paths
    match /{document=**} {
      allow read, write: if false;
    }

  }
}